---
phase: 03-webhook-processing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/utils/logger.ts
  - backend/src/utils/pii-mask.ts
  - backend/src/routes/webhooks.ts
  - backend/src/core/router.ts
autonomous: true

must_haves:
  truths:
    - "Phone numbers are masked in all logs (show last 4 digits only)"
    - "Customer names are redacted in logs"
    - "Response time for context_request is tracked and logged"
    - "Alerts fire if context_request exceeds 500ms"
  artifacts:
    - path: "backend/src/utils/pii-mask.ts"
      provides: "PII masking utility functions"
      exports: ["maskPhone", "maskEmail", "maskPII", "createSafeLogObject"]
    - path: "backend/src/utils/logger.ts"
      provides: "Logger with PII masking"
      contains: "maskPII"
  key_links:
    - from: "backend/src/routes/webhooks.ts"
      to: "backend/src/utils/pii-mask.ts"
      via: "import and usage"
      pattern: "maskPhone|createSafeLogObject"
    - from: "backend/src/core/router.ts"
      to: "backend/src/services/divine/slack.service.ts"
      via: "response time alert"
      pattern: "slackService.*context_request"
---

<objective>
Implement PII masking in logs and response time tracking for context_request.

Purpose: Per CONTEXT.md, logs must mask PII (phone numbers show last 4 digits, names redacted). Additionally, REQ-001 requires <500ms response time for context_request with alerting when exceeded.

Output: All webhook logs mask PII automatically. context_request timing is tracked and alerts fire when >500ms.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-webhook-processing/03-CONTEXT.md

# Key source files
@backend/src/utils/logger.ts
@backend/src/routes/webhooks.ts
@backend/src/core/router.ts
@backend/src/services/divine/slack.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PII masking utility</name>
  <files>backend/src/utils/pii-mask.ts</files>
  <action>
Create a new file `backend/src/utils/pii-mask.ts` with PII masking utilities:

```typescript
/**
 * PII Masking Utilities
 * Masks personally identifiable information in logs for compliance.
 * Per CONTEXT.md: Show last 4 digits of phone, redact names in logs.
 */

/**
 * Mask a phone number, showing only last 4 digits.
 * Example: +15551234567 -> ***4567
 */
export function maskPhone(phone: string | null | undefined): string {
  if (!phone) return '[no phone]';
  const digits = phone.replace(/\D/g, '');
  if (digits.length < 4) return '****';
  return '***' + digits.slice(-4);
}

/**
 * Mask an email address.
 * Example: john.doe@example.com -> j***@example.com
 */
export function maskEmail(email: string | null | undefined): string {
  if (!email) return '[no email]';
  const [local, domain] = email.split('@');
  if (!domain) return '***@***';
  const maskedLocal = local.length > 1 ? local[0] + '***' : '***';
  return `${maskedLocal}@${domain}`;
}

/**
 * Redact a name completely.
 * Example: John Doe -> [name redacted]
 */
export function maskName(name: string | null | undefined): string {
  if (!name) return '[no name]';
  return '[name redacted]';
}

/**
 * Known PII field patterns to mask automatically
 */
const PII_PATTERNS: Record<string, (value: unknown) => string> = {
  phone: (v) => maskPhone(String(v)),
  from_number: (v) => maskPhone(String(v)),
  to_number: (v) => maskPhone(String(v)),
  fromNumber: (v) => maskPhone(String(v)),
  toNumber: (v) => maskPhone(String(v)),
  customerPhone: (v) => maskPhone(String(v)),
  email: (v) => maskEmail(String(v)),
  customerEmail: (v) => maskEmail(String(v)),
  name: (v) => maskName(String(v)),
  customerName: (v) => maskName(String(v)),
  customer_name: (v) => maskName(String(v)),
};

/**
 * Check if a key is a known PII field
 */
function isPIIField(key: string): boolean {
  return key.toLowerCase() in PII_PATTERNS ||
    Object.keys(PII_PATTERNS).some(pattern =>
      key.toLowerCase().includes(pattern.toLowerCase())
    );
}

/**
 * Recursively mask PII in an object.
 * Creates a deep copy with all PII fields masked.
 */
export function maskPII<T extends Record<string, unknown>>(obj: T): T {
  if (!obj || typeof obj !== 'object') return obj;

  const result: Record<string, unknown> = {};

  for (const [key, value] of Object.entries(obj)) {
    // Check if this is a known PII field
    const lowerKey = key.toLowerCase();
    const maskFn = PII_PATTERNS[lowerKey] || PII_PATTERNS[key];

    if (maskFn && value != null) {
      result[key] = maskFn(value);
    } else if (Array.isArray(value)) {
      result[key] = value.map(item =>
        typeof item === 'object' && item !== null
          ? maskPII(item as Record<string, unknown>)
          : item
      );
    } else if (typeof value === 'object' && value !== null) {
      result[key] = maskPII(value as Record<string, unknown>);
    } else {
      result[key] = value;
    }
  }

  return result as T;
}

/**
 * Create a safe log object with PII masked.
 * Use this when logging webhook payloads or customer data.
 *
 * @example
 * logger.info(createSafeLogObject({ phone: '+15551234567', name: 'John' }), 'Customer data');
 * // Logs: { phone: '***4567', name: '[name redacted]' }
 */
export function createSafeLogObject<T extends Record<string, unknown>>(
  obj: T,
  additionalFields?: Record<string, unknown>
): Record<string, unknown> {
  const masked = maskPII(obj);
  return additionalFields ? { ...masked, ...additionalFields } : masked;
}

/**
 * Type-safe wrapper for logging with PII masking.
 * Ensures phone and name fields are always masked.
 */
export interface SafeLogFields {
  phone?: string;
  from_number?: string;
  to_number?: string;
  name?: string;
  customerName?: string;
  email?: string;
  [key: string]: unknown;
}

export function safeLog(fields: SafeLogFields): Record<string, unknown> {
  return maskPII(fields as Record<string, unknown>);
}
```
  </action>
  <verify>
Run TypeScript compiler:
```bash
cd backend && npx tsc --noEmit
```
  </verify>
  <done>PII masking utility created with maskPhone, maskEmail, maskName, maskPII, and createSafeLogObject functions.</done>
</task>

<task type="auto">
  <name>Task 2: Add response time tracking to context_request</name>
  <files>backend/src/core/router.ts</files>
  <action>
Update CentralRouter to track and alert on context_request response time:

1. Add import at top of file:
```typescript
import { slackService } from '../services/divine/slack.service';
import { maskPhone } from '../utils/pii-mask';
```

2. Update handleContextRequest method to track timing and alert:

At the START of handleContextRequest (after the logger.info call):
```typescript
const startTime = Date.now();
```

At the END of handleContextRequest, just before the return statement:
```typescript
// Track response time
const responseTime = Date.now() - startTime;
logger.info({
  callId: call.call_id,
  phone: maskPhone(call.from_number),
  responseTimeMs: responseTime,
  hasContext: Object.keys(response).length > 0,
}, 'context_request processed');

// Alert if response time exceeds 500ms threshold
if (responseTime > 500) {
  logger.warn({
    callId: call.call_id,
    responseTimeMs: responseTime,
    threshold: 500,
  }, 'context_request exceeded 500ms threshold');

  // Send Slack alert for slow context_request
  slackService.sendWarning(
    'Slow context_request Response',
    `context_request took ${responseTime}ms (threshold: 500ms)`,
    { clientId: config.client_id }
  ).catch(err => {
    logger.error({ error: err }, 'Failed to send slow response alert');
  });
}
```

3. Update the existing logger.info calls to use maskPhone for phone numbers:
- Line ~51: Change `call.from_number` usage to mask it
- Line ~95: Already uses object destructuring, no phone exposed

4. In handleCallEnded, also mask phone in any logging:
```typescript
// When logging, use maskPhone
logger.debug({ callId: call.call_id, phone: maskPhone(call.from_number) }, 'Processing call ended');
```
  </action>
  <verify>
1. TypeScript compiles: `cd backend && npx tsc --noEmit`
2. Grep for timing: `grep -n "responseTime" backend/src/core/router.ts`
3. Grep for maskPhone: `grep -n "maskPhone" backend/src/core/router.ts`
  </verify>
  <done>context_request tracks response time, logs it, and alerts via Slack when exceeding 500ms.</done>
</task>

<task type="auto">
  <name>Task 3: Update webhook routes to use PII masking</name>
  <files>backend/src/routes/webhooks.ts</files>
  <action>
Update webhooks.ts to mask PII in all log statements:

1. Add import at top of file:
```typescript
import { maskPhone, createSafeLogObject } from '../utils/pii-mask';
```

2. Update log statements that expose phone numbers:

Line ~94 (webhook received log):
```typescript
logTheatrical.info(`Retell webhook received for client ${clientConfig.client_id}: ${eventType}`);
// No change needed - doesn't log phone
```

Line ~126-127 (warn for no user found):
```typescript
logTheatrical.warn(`No user found for agent_id: ${callData.agent_id}`);
// No change needed - doesn't log phone
```

Line ~163 (success log) - ensure no phone logged:
```typescript
logTheatrical.success(`Stored new call log: ${callData.call_id}`);
// No change needed
```

Line ~169 (call values) - mask phone in the database insert:
The phone is stored in DB (correct), but ensure no logging of raw phone.

Line ~232 (SMS log) - mask phone if logging:
```typescript
// Change any line that logs action.data.to or routerEvent.call.from_number
logTheatrical.success(`SMS sent via Text180 for ${clientConfig.client_id} to ${maskPhone(action.data.to || routerEvent.call.from_number)}`);
```

Line ~256 (error log) - ensure no phone in error:
```typescript
logTheatrical.error(`Webhook processing error for ${clientConfig.client_id}: ${error}`);
// No change needed - doesn't log phone
```

Line ~327 (no clientId webhook):
```typescript
logTheatrical.info(`Retell webhook received (no clientId), agent_id: ${agentId}`);
// No change needed
```

3. Add response time tracking to processRetellWebhook for context_request events:

At the start of processRetellWebhook function:
```typescript
const webhookStartTime = Date.now();
```

After processing completes (before the success response):
```typescript
const webhookDuration = Date.now() - webhookStartTime;
logTheatrical.info(`Webhook processed in ${webhookDuration}ms for ${clientConfig.client_id}`);
```
  </action>
  <verify>
1. TypeScript compiles: `cd backend && npx tsc --noEmit`
2. Grep for maskPhone in webhooks: `grep -n "maskPhone" backend/src/routes/webhooks.ts`
3. No raw phone numbers in log statements: `grep -n "from_number\|to_number" backend/src/routes/webhooks.ts | grep -v "callData\.\|routerEvent\."`
  </verify>
  <done>Webhook routes mask all phone numbers in logs and track response time.</done>
</task>

</tasks>

<verification>
Phase 03 Plan 02 verification:
1. TypeScript compiles: `cd backend && npx tsc --noEmit`
2. PII mask file exists: `test -f backend/src/utils/pii-mask.ts`
3. Response time tracking in router: `grep "responseTimeMs" backend/src/core/router.ts`
4. Slack alert for slow response: `grep "Slow context_request" backend/src/core/router.ts`
5. maskPhone imported in routes: `grep "maskPhone" backend/src/routes/webhooks.ts`
</verification>

<success_criteria>
- New pii-mask.ts utility exists with maskPhone, maskEmail, maskPII functions
- CentralRouter tracks context_request response time and logs it
- Slack alert fires when context_request exceeds 500ms
- Webhook routes use maskPhone for any phone number logging
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-webhook-processing/03-02-SUMMARY.md`
</output>
