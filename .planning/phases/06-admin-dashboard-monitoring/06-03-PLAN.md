---
phase: 06-admin-dashboard-monitoring
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - views/DivineDashboard.tsx
  - components/divine/ErrorMonitorPanel.tsx
  - components/divine/MessageQueueViewer.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can filter dashboard by client using dropdown"
    - "Selected client filter is passed to child components"
    - "ErrorMonitorPanel supports time range filter (1h/6h/24h/7d)"
    - "CallStatusPanel integrated into dashboard overview"
  artifacts:
    - path: "views/DivineDashboard.tsx"
      provides: "Client filter dropdown and CallStatusPanel integration"
      contains: "selectedClientId"
    - path: "components/divine/ErrorMonitorPanel.tsx"
      provides: "Time range filter UI and API call"
      contains: "timeRange"
  key_links:
    - from: "views/DivineDashboard.tsx"
      to: "MessageQueueViewer"
      via: "clientId prop"
      pattern: "<MessageQueueViewer\\s+clientId="
    - from: "views/DivineDashboard.tsx"
      to: "ErrorMonitorPanel"
      via: "clientId prop"
      pattern: "<ErrorMonitorPanel\\s+clientId="
    - from: "views/DivineDashboard.tsx"
      to: "CallStatusPanel"
      via: "clientId prop"
      pattern: "<CallStatusPanel\\s+clientId="
---

<objective>
Add per-client filtering UI and time range filters to complete Phase 6 requirements.

Purpose: REQ-007 requires per-client filtering. The backend APIs already support clientId parameters, but the dashboard has no UI to select a client. Additionally, ErrorMonitorPanel lacks time range filtering, making it hard to focus on recent vs historical errors.

Output: Client filter dropdown in dashboard header, clientId props passed to components, time range filter in ErrorMonitorPanel, CallStatusPanel integrated into overview.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-dashboard-monitoring/06-RESEARCH.md
@.planning/phases/06-admin-dashboard-monitoring/06-01-SUMMARY.md
@.planning/phases/06-admin-dashboard-monitoring/06-02-SUMMARY.md

Key existing code:
- views/DivineDashboard.tsx - Main dashboard with tabs
- components/divine/ErrorMonitorPanel.tsx - Error list component
- components/divine/MessageQueueViewer.tsx - Already accepts clientId prop
- divineApi.getAllClients() - Returns list of client configs
- Backend APIs accept clientId as query parameter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add client filter dropdown to DivineDashboard</name>
  <files>views/DivineDashboard.tsx</files>
  <action>
1. Add state for selected client and clients list at the top of the component (after existing state):
```typescript
const [selectedClientId, setSelectedClientId] = useState<string | null>(null);
const [clients, setClients] = useState<ClientConfig[]>([]);
```

Add ClientConfig to imports:
```typescript
import { divineApi, ErrorStats, Conversation, ClientConfig } from '../src/services/divine';
```

2. Load clients in loadDashboardData (add to the Promise.all):
```typescript
const [statusData, queueData, errorData, conversationsData, clientsData] = await Promise.all([
  divineApi.getSystemStatus(),
  divineApi.getQueueStats(),
  divineApi.getErrorStats(24),
  divineApi.getRecentConversations(5).catch(() => ({ conversations: [], total: 0 })),
  divineApi.getAllClients().catch(() => ({ clients: [], total: 0 }))
]);
```

And set clients:
```typescript
setClients(clientsData.clients);
```

3. Add the client filter dropdown in the header section, after the "Divine System" title div (around line 242), before the button group:
```tsx
{/* Client Filter */}
<div className="flex items-center gap-4">
  <div className="flex items-center gap-2">
    <Users size={14} className="text-gray-500" />
    <select
      value={selectedClientId || ''}
      onChange={(e) => setSelectedClientId(e.target.value || null)}
      className="bg-black/50 border border-white/10 px-3 py-2 text-[10px] uppercase tracking-wider text-white focus:border-xlnc-gold/50 outline-none min-w-[160px]"
    >
      <option value="">All Clients</option>
      {clients.map(client => (
        <option key={client.client_id} value={client.client_id}>
          {client.business_name}
        </option>
      ))}
    </select>
  </div>
  <button
    onClick={loadDashboardData}
    disabled={isRefreshing}
    className="bg-white/5 border border-white/10 text-gray-400 px-6 py-3 text-[10px] font-bold uppercase tracking-[0.2em] hover:bg-white/10 hover:text-white transition-all flex items-center gap-2"
  >
    <RefreshCw size={12} className={isRefreshing ? 'animate-spin' : ''} /> Refresh
  </button>
  <button className="bg-xlnc-gold/10 border border-xlnc-gold/30 text-xlnc-gold px-6 py-3 text-[10px] font-bold uppercase tracking-[0.2em] hover:bg-xlnc-gold hover:text-black transition-all flex items-center gap-2">
    <Settings size={12} /> Configure
  </button>
</div>
```

Move the existing button group into this new structure.

4. Import CallStatusPanel at the top:
```typescript
import {
  DivineStatusWidget,
  MessageQueueViewer,
  ErrorMonitorPanel,
  PRISMAnalytics,
  CallStatusPanel
} from '../components/divine';
```
  </action>
  <verify>Dashboard has client dropdown. Selecting a client updates selectedClientId state.</verify>
  <done>Client filter dropdown appears in dashboard header with all configured clients</done>
</task>

<task type="auto">
  <name>Task 2: Pass clientId to child components and add CallStatusPanel</name>
  <files>views/DivineDashboard.tsx</files>
  <action>
1. Update renderTabContent to pass clientId to components.

For the 'queue' case:
```tsx
case 'queue':
  return <MessageQueueViewer clientId={selectedClientId || undefined} />;
```

For the 'errors' case:
```tsx
case 'errors':
  return <ErrorMonitorPanel clientId={selectedClientId || undefined} />;
```

2. Update the overview tab's two-column layout to include CallStatusPanel. Replace the "Recent Activity" section with CallStatusPanel:

Find the two-column layout section (around line 145-165) and update:
```tsx
{/* Two Column Layout */}
<div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
  {/* System Status */}
  <DivineStatusWidget />

  {/* Real-time Call Status */}
  <CallStatusPanel clientId={selectedClientId || undefined} maxRecent={5} />
</div>
```

This replaces the "Recent Call Activity" placeholder section with the real-time CallStatusPanel.

3. Remove the old "Recent Activity" hardcoded section that we replaced with real data in 06-01, since CallStatusPanel now handles this with real-time WebSocket data (the sections around lines 150-164 with Phone icon and "No recent calls" - these should now be removed since Task 3 of plan 01 added this but CallStatusPanel is a better solution).

Note: The recentCalls state and API call can remain for compatibility, but CallStatusPanel provides real-time updates which is superior.
  </action>
  <verify>MessageQueueViewer and ErrorMonitorPanel receive clientId prop. CallStatusPanel shows in overview.</verify>
  <done>Child components receive clientId prop and filter data accordingly. CallStatusPanel integrated into overview.</done>
</task>

<task type="auto">
  <name>Task 3: Add time range filter to ErrorMonitorPanel</name>
  <files>components/divine/ErrorMonitorPanel.tsx</files>
  <action>
1. Add clientId prop and time range state to ErrorMonitorPanel. Update interface and add state:

```typescript
interface ErrorMonitorPanelProps {
  clientId?: string;
}

const ErrorMonitorPanel: React.FC<ErrorMonitorPanelProps> = ({ clientId }) => {
  // ... existing state ...
  const [timeRange, setTimeRange] = useState<'1h' | '6h' | '24h' | '7d'>('24h');
```

2. Update loadData to use timeRange and clientId:
```typescript
const loadData = async () => {
  try {
    setIsLoading(true);
    const hours = timeRange === '1h' ? 1 : timeRange === '6h' ? 6 : timeRange === '24h' ? 24 : 168;
    const [statsData, errorsData] = await Promise.all([
      divineApi.getErrorStats(hours),
      showResolved
        ? divineApi.getRecentErrors(50)
        : divineApi.getUnresolvedErrors(),
    ]);
    setStats(statsData.stats);

    // Filter by clientId if provided
    const filteredErrors = clientId
      ? errorsData.errors.filter(e => e.clientId === clientId)
      : errorsData.errors;
    setErrors(filteredErrors);
  } catch (error) {
    console.error('Failed to load error data:', error);
  } finally {
    setIsLoading(false);
  }
};
```

3. Add timeRange to useEffect dependencies:
```typescript
useEffect(() => {
  loadData();
  const interval = setInterval(loadData, 30000);
  return () => clearInterval(interval);
}, [showResolved, timeRange, clientId]);
```

4. Add the time range filter UI in the header, after the title and before the refresh button:
```tsx
{/* Header */}
<div className="flex items-center justify-between mb-6">
  <div className="flex items-center gap-3">
    <AlertTriangle size={18} className="text-red-500" />
    <h3 className="text-sm font-bold text-white uppercase tracking-wider">Error Monitor</h3>
  </div>
  <div className="flex items-center gap-3">
    {/* Time Range Filter */}
    <div className="flex border border-white/10">
      {(['1h', '6h', '24h', '7d'] as const).map((range) => (
        <button
          key={range}
          onClick={() => setTimeRange(range)}
          className={`px-3 py-1 text-[9px] font-bold uppercase transition-colors ${
            timeRange === range
              ? 'bg-xlnc-gold/20 text-xlnc-gold'
              : 'text-gray-500 hover:text-white hover:bg-white/5'
          }`}
        >
          {range}
        </button>
      ))}
    </div>
    <button
      onClick={loadData}
      disabled={isLoading}
      className="text-gray-500 hover:text-white transition-colors p-1"
    >
      <RefreshCw size={14} className={isLoading ? 'animate-spin' : ''} />
    </button>
  </div>
</div>
```

5. Update the stats header text to reflect the selected time range:
```tsx
<div className="text-xl font-bold text-white">{stats.total}</div>
<div className="text-[9px] text-gray-500 uppercase tracking-wider">
  Total ({timeRange === '7d' ? '7 days' : timeRange})
</div>
```
  </action>
  <verify>ErrorMonitorPanel shows time range buttons (1h/6h/24h/7d). Changing range reloads data.</verify>
  <done>ErrorMonitorPanel has time range filter that updates stats and error list based on selection</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should compile without errors
2. Start frontend, navigate to Divine Dashboard
3. Verify client filter dropdown appears in header with "All Clients" and configured clients
4. Select a client - verify MessageQueueViewer and ErrorMonitorPanel filter by that client
5. Navigate to Error Monitor tab - verify time range buttons (1h/6h/24h/7d)
6. Click different time ranges - verify stats update (Total label shows correct range)
7. Overview tab should show CallStatusPanel with real-time connection status
8. If a call comes in, it should appear in CallStatusPanel immediately
</verification>

<success_criteria>
- Client filter dropdown in dashboard header with all configured clients
- Selecting "All Clients" shows data from all clients
- Selecting specific client filters MessageQueueViewer, ErrorMonitorPanel, and CallStatusPanel
- ErrorMonitorPanel has time range filter (1h/6h/24h/7d) that updates displayed data
- CallStatusPanel integrated into overview tab showing real-time call status
- All components respect the clientId filter when provided
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-dashboard-monitoring/06-03-SUMMARY.md`
</output>
