---
phase: 02-calendar-booking-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/config/clients/smart-tax-nation.json
  - backend/.env
autonomous: false

must_haves:
  truths:
    - "Zoho OAuth token refresh succeeds"
    - "Calendar ID is valid and accessible"
    - "Environment variables are configured correctly"
  artifacts:
    - path: "backend/config/clients/smart-tax-nation.json"
      provides: "Zoho credentials configuration"
      contains: "zoho_calendar_id"
    - path: "backend/.env"
      provides: "OAuth credentials"
      contains: "ZOHO_REFRESH_TOKEN"
  key_links:
    - from: "backend/src/services/divine/zoho-calendar.service.ts"
      to: "Zoho API"
      via: "OAuth token refresh"
      pattern: "accounts.zoho.com/oauth/v2/token"
---

<objective>
Verify and configure Zoho OAuth credentials for Smart Tax Nation calendar integration.

Purpose: The calendar service exists but requires valid OAuth credentials. This plan verifies credentials work and establishes the OAuth token refresh flow.

Output: Working Zoho OAuth connection with verified token refresh capability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-booking-flow/02-RESEARCH.md

@backend/src/services/divine/zoho-calendar.service.ts
@backend/oauth-test.ts
@backend/config/clients/smart-tax-nation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Zoho OAuth Configuration</name>
  <files>backend/.env</files>
  <action>
    Check if existing Zoho OAuth credentials in .env are valid by testing token refresh.

    1. Read current .env to check for ZOHO_CLIENT_ID, ZOHO_CLIENT_SECRET, ZOHO_REFRESH_TOKEN
    2. If credentials exist, test token refresh using curl:
       ```bash
       curl -X POST "https://accounts.zoho.com/oauth/v2/token" \
         -d "grant_type=refresh_token" \
         -d "client_id=$ZOHO_CLIENT_ID" \
         -d "client_secret=$ZOHO_CLIENT_SECRET" \
         -d "refresh_token=$ZOHO_REFRESH_TOKEN"
       ```
    3. If token refresh succeeds (returns access_token), credentials are valid
    4. If token refresh fails, note the error for the checkpoint

    Do NOT modify any files in this task - verification only.
  </action>
  <verify>Curl command returns JSON with "access_token" field, or clear error message is captured.</verify>
  <done>OAuth token refresh status is known - either working or specific error identified.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Confirm Zoho Credentials</name>
  <what-built>Verified OAuth token refresh status for Smart Tax Nation's Zoho Calendar.</what-built>
  <how-to-verify>
    Based on Task 1 results:

    **If token refresh succeeded:**
    1. Confirm this is the correct Zoho account for Smart Tax Nation
    2. Verify calendar ID c349f76861954b919e182591808d02b9 is the right calendar

    **If token refresh failed:**
    1. User needs to provide valid Zoho OAuth credentials
    2. Options:
       a) Run `npx tsx backend/oauth-test.ts` and visit http://localhost:3001 to complete OAuth flow
       b) Provide credentials directly from Zoho API Console

    Required env vars:
    - ZOHO_CLIENT_ID
    - ZOHO_CLIENT_SECRET
    - ZOHO_REFRESH_TOKEN
    - ZOHO_CALENDAR_ID (should be c349f76861954b919e182591808d02b9)
  </how-to-verify>
  <resume-signal>Type "credentials confirmed" if working, or provide new credentials to add to .env</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Validate Calendar Access</name>
  <files>backend/scripts/test-function-dispatch.ts</files>
  <action>
    With confirmed credentials, validate calendar access by fetching events.

    1. Run the test script to verify calendar access:
       ```bash
       cd backend && npx tsx scripts/test-function-dispatch.ts
       ```
    2. The script will:
       - Check if calendar service is configured
       - Fetch available slots for tomorrow
       - Format slots for speech output
    3. Verify the calendar ID is accessible and returns event data

    If test fails with auth error, the refresh token may need regeneration.
    If test succeeds but no calendar access, the calendar ID may be wrong.
  </action>
  <verify>Test script outputs "Calendar service is configured" and lists available time slots.</verify>
  <done>Calendar API access verified - can fetch events and compute availability.</done>
</task>

</tasks>

<verification>
- [ ] Zoho OAuth token refresh succeeds
- [ ] Calendar ID is accessible via Zoho Calendar API
- [ ] Test script shows available appointment slots
- [ ] No authentication errors in logs
</verification>

<success_criteria>
1. OAuth token refresh returns valid access_token
2. Calendar events can be fetched for a given date range
3. Available slots computation returns valid time slots
4. All credentials are documented in .env (not committed)
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-booking-flow/02-01-SUMMARY.md`
</output>
