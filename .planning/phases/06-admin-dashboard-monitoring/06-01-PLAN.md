---
phase: 06-admin-dashboard-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/DivineDashboard.tsx
  - src/services/divine.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard overview shows real error counts by severity"
    - "Dashboard overview shows recent call activity with actual data"
    - "Error summary updates reflect actual error stats API response"
  artifacts:
    - path: "views/DivineDashboard.tsx"
      provides: "Wired overview with real error stats and recent calls"
      contains: "errorData?.stats?.bySeverity"
    - path: "src/services/divine.ts"
      provides: "API method for recent conversations"
      exports: ["getRecentConversations"]
  key_links:
    - from: "views/DivineDashboard.tsx"
      to: "/divine/conversations"
      via: "getRecentConversations API call in loadDashboardData"
      pattern: "divineApi\\.getRecentConversations"
    - from: "views/DivineDashboard.tsx"
      to: "errorData.stats.bySeverity"
      via: "direct property access"
      pattern: "errorData\\.stats\\.bySeverity"
---

<objective>
Wire DivineDashboard overview to display real data from existing API endpoints.

Purpose: The dashboard overview currently shows hardcoded zeros for error counts and a "No recent calls" placeholder. The API endpoints and data structures already exist (getErrorStats, getConversations). This task wires the existing data to the UI.

Output: Dashboard overview displays real error statistics and recent call activity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-dashboard-monitoring/06-RESEARCH.md

Key existing code:
- views/DivineDashboard.tsx - Lines 181-199 show hardcoded error summary with zeros
- src/services/divine.ts - getErrorStats(hours) returns stats.bySeverity object
- src/services/divine.ts - getConversations(clientId, limit) returns recent conversations
- conversationService.getRecentByClient(clientId) - Backend method for recent calls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API method for recent conversations (all clients)</name>
  <files>src/services/divine.ts, backend/src/routes/divine.ts</files>
  <action>
1. In backend/src/routes/divine.ts, add a new endpoint for admin to get recent conversations across all clients:

```typescript
/**
 * GET /divine/conversations/recent
 * Get recent conversations across all clients (admin)
 */
router.get('/conversations/recent', authenticateToken, requireAdmin, async (req: AuthRequest, res: Response) => {
  try {
    const { limit = '10' } = req.query;
    // Use SQL to get recent across all clients
    const conversations = await db
      .select()
      .from(conversationsTable)
      .orderBy(desc(conversationsTable.createdAt))
      .limit(parseInt(limit as string));
    res.json(createTheatricalResponse({ conversations, total: conversations.length }));
  } catch (error) {
    res.status(500).json(createErrorResponse('Failed to get recent conversations', 500));
  }
});
```

Add necessary imports at top: `import { conversations as conversationsTable } from '../db/schema/conversations';` and `import { desc } from 'drizzle-orm';`

2. In src/services/divine.ts, add the frontend API method:

```typescript
async getRecentConversations(limit?: number): Promise<{ conversations: Conversation[]; total: number }> {
  const response = await api.get('/divine/conversations/recent', { params: { limit } });
  return response.data.data;
},
```

Add this method after the existing getConversation method.
  </action>
  <verify>TypeScript compiles without errors. Endpoint exists in routes.</verify>
  <done>GET /divine/conversations/recent endpoint returns recent calls across all clients</done>
</task>

<task type="auto">
  <name>Task 2: Wire error summary to real stats</name>
  <files>views/DivineDashboard.tsx</files>
  <action>
In DivineDashboard.tsx, the loadDashboardData function already fetches errorData via getErrorStats(24). Update the Error Summary section (around lines 181-199) to use real data instead of hardcoded zeros.

1. Store errorData in component state. Add state variable:
```typescript
const [errorData, setErrorData] = useState<{ stats: ErrorStats } | null>(null);
```

Import ErrorStats from divine service: `import { divineApi, ErrorStats } from '../src/services/divine';`

2. In loadDashboardData, save the errorData:
```typescript
setErrorData(errorData);
```

3. Replace the hardcoded grid (lines ~181-199) with:
```tsx
<div className="grid grid-cols-4 gap-4">
  <div className="text-center p-4 bg-white/5">
    <div className="text-2xl font-bold text-red-500">
      {errorData?.stats?.bySeverity?.critical || 0}
    </div>
    <div className="text-[9px] text-gray-500 uppercase mt-1">Critical</div>
  </div>
  <div className="text-center p-4 bg-white/5">
    <div className="text-2xl font-bold text-orange-500">
      {errorData?.stats?.bySeverity?.error || 0}
    </div>
    <div className="text-[9px] text-gray-500 uppercase mt-1">Errors</div>
  </div>
  <div className="text-center p-4 bg-white/5">
    <div className="text-2xl font-bold text-yellow-500">
      {errorData?.stats?.bySeverity?.warning || 0}
    </div>
    <div className="text-[9px] text-gray-500 uppercase mt-1">Warnings</div>
  </div>
  <div className="text-center p-4 bg-white/5">
    <div className="text-2xl font-bold text-emerald-500">
      {errorData?.stats?.total || 0}
    </div>
    <div className="text-[9px] text-gray-500 uppercase mt-1">Total (24h)</div>
  </div>
</div>
```
  </action>
  <verify>Dashboard overview shows actual error severity counts from API. Build compiles.</verify>
  <done>Error summary section displays real counts from getErrorStats API response</done>
</task>

<task type="auto">
  <name>Task 3: Wire recent calls to real conversation data</name>
  <files>views/DivineDashboard.tsx</files>
  <action>
Replace the "No recent calls" placeholder with actual call data from the API.

1. Add Conversation type import:
```typescript
import { divineApi, ErrorStats, Conversation } from '../src/services/divine';
```

2. Modify loadDashboardData to fetch recent conversations:
```typescript
const [statusData, queueData, errorData, conversationsData] = await Promise.all([
  divineApi.getSystemStatus(),
  divineApi.getQueueStats(),
  divineApi.getErrorStats(24),
  divineApi.getRecentConversations(5).catch(() => ({ conversations: [], total: 0 }))
]);
```

3. Update setRecentCalls to use actual data:
```typescript
setRecentCalls(conversationsData.conversations);
```

4. Replace the Recent Call Activity section content (the placeholder around lines 156-163) with:
```tsx
{recentCalls.length === 0 ? (
  <div className="text-center py-8 text-gray-600">
    <Phone size={32} className="mx-auto mb-3 opacity-30" />
    <div className="text-sm">No recent calls</div>
    <div className="text-[10px] mt-1">Calls will appear here as they are processed</div>
  </div>
) : (
  <div className="space-y-2">
    {recentCalls.map((call: Conversation) => (
      <div key={call.id} className="flex items-center justify-between p-3 bg-white/5 border border-white/5 hover:border-white/10 transition-colors">
        <div className="flex items-center gap-3">
          <div className={`w-2 h-2 rounded-full ${
            call.status === 'completed' ? 'bg-emerald-500' :
            call.status === 'in_progress' ? 'bg-amber-500 animate-pulse' :
            'bg-gray-500'
          }`} />
          <div>
            <div className="text-sm text-white">
              {call.intent || 'Unknown Intent'}
            </div>
            <div className="text-[10px] text-gray-500">
              {call.durationMs ? `${Math.round(call.durationMs / 1000)}s` : 'In Progress'}
              {call.sentiment && ` â€¢ ${call.sentiment}`}
            </div>
          </div>
        </div>
        <div className="text-[10px] text-gray-500">
          {new Date(call.createdAt).toLocaleTimeString()}
        </div>
      </div>
    ))}
  </div>
)}
```

5. Update the recentCalls type annotation from `any[]` to `Conversation[]`:
```typescript
const [recentCalls, setRecentCalls] = useState<Conversation[]>([]);
```
  </action>
  <verify>Dashboard shows recent call entries with intent, duration, sentiment. Falls back gracefully if no calls exist.</verify>
  <done>Recent Call Activity section shows real conversation data from API with status, intent, duration, and timestamp</done>
</task>

</tasks>

<verification>
1. Run `npm run build` in frontend - should compile without errors
2. Start backend and frontend in dev mode
3. Navigate to Divine Dashboard
4. Overview tab should show:
   - Error Summary with counts from actual error_logs table
   - Recent Call Activity with actual conversation data (or graceful empty state)
5. Refresh button should update both sections with fresh data
</verification>

<success_criteria>
- Dashboard overview error summary shows real counts (critical, error, warning, total)
- Dashboard overview recent calls section displays actual conversation data
- API endpoint GET /divine/conversations/recent works for admin users
- Empty state gracefully handled when no conversations exist
- Build compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-dashboard-monitoring/06-01-SUMMARY.md`
</output>
