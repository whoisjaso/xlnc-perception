---
phase: 06.1-client-onboarding-oauth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/oauthStates.ts
  - backend/src/db/migrations/add-oauth-states.ts
  - backend/src/routes/oauth.ts
  - backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can initiate OAuth flow for any client by hitting GET /api/oauth/authorize/:clientId"
    - "Zoho redirects back to callback and tokens are stored in oauth_tokens table"
    - "OAuth state parameter prevents CSRF attacks with 10-minute TTL"
  artifacts:
    - path: "backend/src/db/schema/oauthStates.ts"
      provides: "OAuth state storage schema for CSRF protection"
      contains: "oauth_states"
    - path: "backend/src/routes/oauth.ts"
      provides: "OAuth initiation and callback endpoints"
      exports: ["default"]
    - path: "backend/src/db/migrations/add-oauth-states.ts"
      provides: "Migration for oauth_states table"
  key_links:
    - from: "backend/src/routes/oauth.ts"
      to: "backend/src/services/divine/oauth-token.service.ts"
      via: "oauthTokenService.storeTokens() in callback"
      pattern: "oauthTokenService\\.storeTokens"
    - from: "backend/src/routes/oauth.ts"
      to: "backend/src/services/divine/client-config.service.ts"
      via: "clientConfigService.getConfig() to get Zoho app credentials"
      pattern: "clientConfigService\\.getConfig"
    - from: "backend/src/index.ts"
      to: "backend/src/routes/oauth.ts"
      via: "app.use mount"
      pattern: "oauth"
---

<objective>
Create the OAuth authorization code flow for per-client Zoho CRM/Calendar authorization.

Purpose: Admins need to initiate OAuth for any client's CRM/Calendar, replacing the manual refresh-token-only setup. This is the foundation for client onboarding and token recovery.
Output: Working OAuth initiate + callback endpoints that store tokens via existing OAuthTokenService.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-RESEARCH.md
@backend/src/services/divine/oauth-token.service.ts
@backend/src/db/schema/oauthTokens.ts
@backend/src/routes/divine.ts
@backend/src/config/env.ts
@backend/src/services/divine/client-config.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: OAuth state schema and migration</name>
  <files>backend/src/db/schema/oauthStates.ts, backend/src/db/migrations/add-oauth-states.ts</files>
  <action>
    Create `backend/src/db/schema/oauthStates.ts`:
    - Table `oauth_states` with columns: id (uuid PK), state (varchar 255, unique index), clientId (varchar 255), provider (varchar 50), createdAt (timestamp, defaultNow), expiresAt (timestamp)
    - Export types OAuthState, NewOAuthState

    Create migration `backend/src/db/migrations/add-oauth-states.ts`:
    - Creates oauth_states table
    - Follow pattern of existing migrations in the migrations folder (check what exists)

    Export from schema barrel file if one exists, or ensure the new schema is importable.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` from backend directory (or equivalent check that the schema file has no type errors)</verify>
  <done>oauth_states schema exists with state, clientId, provider, expiresAt columns and unique index on state</done>
</task>

<task type="auto">
  <name>Task 2: OAuth authorization routes (initiate + callback)</name>
  <files>backend/src/routes/oauth.ts, backend/src/index.ts</files>
  <action>
    Create `backend/src/routes/oauth.ts` with Express Router:

    **GET /authorize/:clientId** (protected: authenticateToken + requireAdmin):
    1. Accept query param `provider` (default 'zoho_crm', also supports 'zoho_calendar')
    2. Load client config via clientConfigService.getConfig(clientId) - 404 if not found
    3. Get Zoho app credentials: config.zoho_client_id || env.ZOHO_CLIENT_ID (same for secret). 400 if missing.
    4. Generate state = `${clientId}:${crypto.randomBytes(16).toString('hex')}`
    5. Store state in oauth_states table with expiresAt = now + 10 minutes
    6. Build Zoho auth URL using URLSearchParams:
       - scope: 'ZohoCRM.modules.ALL,ZohoCRM.settings.ALL' for zoho_crm, 'ZohoCalendar.calendar.ALL' for zoho_calendar
       - client_id, redirect_uri (env.ZOHO_REDIRECT_URI or `${BASE_URL}/api/oauth/callback`), response_type: 'code', access_type: 'offline', prompt: 'consent', state
    7. Return JSON with { authUrl } (don't redirect - let frontend handle it). This is better for SPA flow.

    **GET /callback** (NO auth - Zoho redirects here):
    1. Extract code, state, error from query params
    2. If error, return 400 with error description
    3. Look up state in oauth_states table. If not found or expired (expiresAt < now), return 400 'Invalid or expired state'
    4. Delete the state record (one-time use)
    5. Parse clientId from state (split on ':')[0]
    6. Load client config for Zoho app credentials
    7. Exchange code for tokens: POST to https://accounts.zoho.com/oauth/v2/token with grant_type=authorization_code, client_id, client_secret, redirect_uri, code. Use application/x-www-form-urlencoded.
    8. Store tokens via oauthTokenService.storeTokens(clientId, provider, { accessToken, refreshToken, expiresIn, scopes, metadata: { api_domain } })
    9. Redirect to frontend success page: `${env.FRONTEND_URL}/admin/clients/${clientId}?oauth=success&provider=${provider}`
    10. On any exchange error, redirect to `${env.FRONTEND_URL}/admin/clients/${clientId}?oauth=error`

    **GET /status/:clientId** (protected: authenticateToken + requireAdmin):
    1. Accept query param `provider` (optional, if omitted check both zoho_crm and zoho_calendar)
    2. For each provider, call oauthTokenService.getTokenRecord(clientId, provider)
    3. Return { tokens: [{ provider, hasToken, tokenExpiry, updatedAt }] }

    Mount in index.ts: import oauthRoutes and `app.use('/api/oauth', oauthRoutes)`. Check how divine routes are mounted and follow the same pattern.

    Add `BASE_URL` to env.ts as optional string (used for OAuth redirect_uri construction). Use ZOHO_REDIRECT_URI if set, otherwise construct from BASE_URL.
  </action>
  <verify>
    TypeScript compiles without errors.
    Start server and confirm routes are mounted: `curl http://localhost:3000/api/oauth/status/smart-tax-nation` (should return 401 without auth, proving route exists).
  </verify>
  <done>
    - GET /api/oauth/authorize/:clientId returns authUrl for Zoho OAuth
    - GET /api/oauth/callback exchanges code for tokens and stores via OAuthTokenService
    - GET /api/oauth/status/:clientId returns token status per provider
    - Routes mounted in index.ts
  </done>
</task>

</tasks>

<verification>
- oauth_states table schema exists with proper types
- OAuth routes compile and mount correctly
- authorize endpoint generates valid Zoho OAuth URL with correct scopes, access_type=offline, prompt=consent
- callback endpoint exchanges code and stores tokens via oauthTokenService.storeTokens
- State parameter has 10-minute TTL and is deleted after use
</verification>

<success_criteria>
Admin can hit /api/oauth/authorize/:clientId to get a Zoho OAuth URL, and after Zoho authorization, the callback stores tokens in the database via OAuthTokenService.
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-01-SUMMARY.md`
</output>
