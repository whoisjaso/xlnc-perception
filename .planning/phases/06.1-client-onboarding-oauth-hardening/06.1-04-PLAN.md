---
phase: 06.1-client-onboarding-oauth-hardening
plan: 04
type: execute
wave: 2
depends_on: ["06.1-01", "06.1-02"]
files_modified:
  - backend/src/routes/oauth.ts
  - backend/src/routes/divine.ts
autonomous: true

must_haves:
  truths:
    - "Admin can trigger re-authorization for a client with invalid/expired tokens"
    - "Admin can view token health status for all clients from a single endpoint"
    - "Re-auth flow reuses the same OAuth initiation endpoint from Plan 01"
  artifacts:
    - path: "backend/src/routes/oauth.ts"
      provides: "Re-auth endpoint that deletes old token and redirects to OAuth"
    - path: "backend/src/routes/divine.ts"
      provides: "Token health dashboard endpoint"
  key_links:
    - from: "backend/src/routes/divine.ts"
      to: "backend/src/services/divine/token-health.service.ts"
      via: "GET /divine/oauth/health endpoint"
      pattern: "tokenHealthService"
    - from: "backend/src/routes/oauth.ts"
      to: "backend/src/services/divine/oauth-token.service.ts"
      via: "deleteToken before re-auth"
      pattern: "deleteToken"
---

<objective>
Add token recovery endpoints and admin health visibility for OAuth tokens.

Purpose: When tokens become invalid, admins need a clear path to re-authorize. They also need a single view of all token health across clients.
Output: Re-auth endpoint + token health listing endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-01-SUMMARY.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-02-SUMMARY.md
@backend/src/routes/oauth.ts
@backend/src/routes/divine.ts
@backend/src/services/divine/token-health.service.ts
@backend/src/services/divine/oauth-token.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add re-auth and health endpoints</name>
  <files>backend/src/routes/oauth.ts, backend/src/routes/divine.ts</files>
  <action>
    **In oauth.ts, add:**

    **POST /reauthorize/:clientId** (authenticateToken + requireAdmin):
    1. Accept body { provider: 'zoho_crm' | 'zoho_calendar' }
    2. Delete existing token: oauthTokenService.deleteToken(clientId, provider)
    3. Log the re-auth initiation
    4. Return { message: 'Token deleted. Initiate new OAuth flow.', authorizeUrl: `/api/oauth/authorize/${clientId}?provider=${provider}` }
    This keeps it simple - admin calls reauthorize to clear bad token, then initiates OAuth.

    **In divine.ts, add (in a new OAUTH HEALTH section):**

    **GET /divine/oauth/health** (authenticateToken + requireAdmin):
    1. Import tokenHealthService
    2. Call tokenHealthService.checkAllTokens()
    3. Return createTheatricalResponse({ tokens: reports, unhealthy: reports.filter(r => r.status !== 'healthy').length })

    **POST /divine/oauth/health/check** (authenticateToken + requireAdmin):
    1. Force an immediate health check: tokenHealthService.checkAllTokens()
    2. Call tokenHealthService.alertOnUnhealthy(reports)
    3. Return createTheatricalResponse({ checked: reports.length, unhealthy: unhealthyCount, reports })

    Import tokenHealthService in divine.ts. Ensure it starts its periodic check on import (or add startup call in index.ts alongside other service initializations).
  </action>
  <verify>
    TypeScript compiles. All new endpoints respond correctly:
    - POST /api/oauth/reauthorize/:clientId returns authorize URL
    - GET /divine/oauth/health returns token health reports
    - POST /divine/oauth/health/check triggers immediate check
  </verify>
  <done>
    - Admin can clear bad tokens and get re-auth URL via POST /api/oauth/reauthorize/:clientId
    - Admin can view all token health via GET /divine/oauth/health
    - Admin can force health check via POST /divine/oauth/health/check
    - TokenHealthService periodic check starts on server boot
  </done>
</task>

</tasks>

<verification>
- Re-auth endpoint deletes token and returns authorize URL
- Health endpoint returns status for all client/provider token pairs
- Force-check endpoint triggers immediate health check with alerting
- TokenHealthService periodic monitoring active on server startup
</verification>

<success_criteria>
Admin has complete OAuth lifecycle management: initiate auth (Plan 01), monitor health (Plan 02), view health dashboard and trigger recovery (this plan).
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-04-SUMMARY.md`
</output>
