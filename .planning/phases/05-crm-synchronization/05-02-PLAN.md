---
phase: 05-crm-synchronization
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/services/divine/zoho-crm.service.ts
  - backend/src/services/divine/zoho-calendar.service.ts
autonomous: true

must_haves:
  truths:
    - "ZohoCRMService uses database-backed tokens instead of in-memory cache"
    - "ZohoCalendarService uses database-backed tokens instead of in-memory cache"
    - "Both services fall back to env vars when no DB token exists"
  artifacts:
    - path: "backend/src/services/divine/zoho-crm.service.ts"
      provides: "CRM service with OAuthTokenService integration"
      contains: "oauthTokenService"
    - path: "backend/src/services/divine/zoho-calendar.service.ts"
      provides: "Calendar service with OAuthTokenService integration"
      contains: "oauthTokenService"
  key_links:
    - from: "backend/src/services/divine/zoho-crm.service.ts"
      to: "backend/src/services/divine/oauth-token.service.ts"
      via: "import and method call"
      pattern: "oauthTokenService\\.getAccessToken"
    - from: "backend/src/services/divine/zoho-calendar.service.ts"
      to: "backend/src/services/divine/oauth-token.service.ts"
      via: "import and method call"
      pattern: "oauthTokenService\\.getAccessToken"
---

<objective>
Update Zoho services to use database-backed OAuth tokens.

Purpose: Replace in-memory token caching in both ZohoCRMService and ZohoCalendarService with the new OAuthTokenService. This ensures tokens persist across server restarts and can be shared across multiple instances.

Output:
- ZohoCRMService refactored to use OAuthTokenService
- ZohoCalendarService refactored to use OAuthTokenService
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-crm-synchronization/05-RESEARCH.md
@.planning/phases/05-crm-synchronization/05-01-SUMMARY.md

# Services to update
@backend/src/services/divine/zoho-crm.service.ts
@backend/src/services/divine/zoho-calendar.service.ts
@backend/src/services/divine/oauth-token.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ZohoCRMService to use OAuthTokenService</name>
  <files>backend/src/services/divine/zoho-crm.service.ts</files>
  <action>
Refactor `backend/src/services/divine/zoho-crm.service.ts` to use OAuthTokenService:

1. Import the token service:
```typescript
import { oauthTokenService } from './oauth-token.service';
```

2. Remove in-memory token caching:
- DELETE: `private accessToken: string | null = null;`
- DELETE: `private tokenExpiry: Date | null = null;`

3. Add a clientId property for token lookups:
```typescript
private readonly serviceClientId: string; // For multi-tenant token lookup
```

4. Update constructor to accept clientId:
```typescript
constructor(credentials?: ZohoCRMCredentials, clientId: string = 'default') {
  this.serviceClientId = clientId;
  this.clientId = credentials?.clientId || env.ZOHO_CLIENT_ID || env.ZOHO_CRM_CLIENT_ID || '';
  this.clientSecret = credentials?.clientSecret || env.ZOHO_CLIENT_SECRET || env.ZOHO_CRM_CLIENT_SECRET || '';
  this.refreshToken = credentials?.refreshToken || env.ZOHO_REFRESH_TOKEN || env.ZOHO_CRM_REFRESH_TOKEN || '';
}
```

5. Replace getAccessToken method:
```typescript
async getAccessToken(): Promise<string> {
  // Use OAuthTokenService for database-backed tokens
  return oauthTokenService.getAccessToken(
    this.serviceClientId,
    'zoho_crm',
    { clientId: this.clientId, clientSecret: this.clientSecret }
  );
}
```

6. Update forClient static method:
```typescript
static forClient(clientConfig: {
  zoho_client_id?: string | null;
  zoho_client_secret?: string | null;
  zoho_refresh_token?: string | null;
}, clientId: string = 'default'): ZohoCRMService {
  return new ZohoCRMService({
    clientId: clientConfig.zoho_client_id,
    clientSecret: clientConfig.zoho_client_secret,
    refreshToken: clientConfig.zoho_refresh_token,
  }, clientId);
}
```

7. Keep isConfigured() as-is (checks credentials exist)

WHY these changes:
- Removes duplicate token caching logic (now in OAuthTokenService)
- Enables multi-client support via serviceClientId
- Maintains backward compatibility with existing API
- forClient() still works for client-specific service instances
  </action>
  <verify>Run `npm run build` in backend/ - verify no TypeScript errors. Existing code using `zohoCRMService.getAccessToken()` should still work.</verify>
  <done>ZohoCRMService uses OAuthTokenService for token management. In-memory cache removed. forClient() updated.</done>
</task>

<task type="auto">
  <name>Task 2: Update ZohoCalendarService to use OAuthTokenService</name>
  <files>backend/src/services/divine/zoho-calendar.service.ts</files>
  <action>
Refactor `backend/src/services/divine/zoho-calendar.service.ts` to use OAuthTokenService:

1. Import the token service:
```typescript
import { oauthTokenService } from './oauth-token.service';
```

2. Remove in-memory token caching:
- DELETE: `private accessToken: string | null = null;`
- DELETE: `private tokenExpiry: Date | null = null;`

3. Add a clientId property for token lookups:
```typescript
private readonly serviceClientId: string; // For multi-tenant token lookup
```

4. Update constructor to accept clientId:
```typescript
constructor(credentials?: ZohoCalendarCredentials, clientId: string = 'default') {
  this.serviceClientId = clientId;
  this.clientId = credentials?.clientId || env.ZOHO_CLIENT_ID || env.ZOHO_CALENDAR_CLIENT_ID || '';
  this.clientSecret = credentials?.clientSecret || env.ZOHO_CLIENT_SECRET || env.ZOHO_CALENDAR_CLIENT_SECRET || '';
  this.refreshToken = credentials?.refreshToken || env.ZOHO_REFRESH_TOKEN || env.ZOHO_CALENDAR_REFRESH_TOKEN || '';
  this.calendarId = credentials?.calendarId || env.ZOHO_CALENDAR_ID || '';
}
```

5. Replace getAccessToken method:
```typescript
async getAccessToken(): Promise<string> {
  // Use OAuthTokenService for database-backed tokens
  return oauthTokenService.getAccessToken(
    this.serviceClientId,
    'zoho_calendar',
    { clientId: this.clientId, clientSecret: this.clientSecret }
  );
}
```

6. Update forClient static method:
```typescript
static forClient(clientConfig: {
  zoho_client_id?: string | null;
  zoho_client_secret?: string | null;
  zoho_refresh_token?: string | null;
  zoho_calendar_id?: string | null;
}, clientId: string = 'default'): ZohoCalendarService {
  return new ZohoCalendarService({
    clientId: clientConfig.zoho_client_id,
    clientSecret: clientConfig.zoho_client_secret,
    refreshToken: clientConfig.zoho_refresh_token,
    calendarId: clientConfig.zoho_calendar_id,
  }, clientId);
}
```

7. Keep isConfigured() as-is (checks credentials + calendarId exist)

WHY these changes:
- Same refactoring pattern as ZohoCRMService for consistency
- Calendar service was already tested working in Phase 2
- OAuthTokenService handles the shared token refresh logic
  </action>
  <verify>Run `npm run build` in backend/ - verify no TypeScript errors. Calendar service methods (getAvailableSlots, createEvent) should still work.</verify>
  <done>ZohoCalendarService uses OAuthTokenService for token management. In-memory cache removed. forClient() updated.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes in backend/
2. Both Zoho services import and use OAuthTokenService
3. No in-memory token caching remains in either service
4. Existing service APIs unchanged (backward compatible)
5. forClient() pattern still works for multi-tenant usage
</verification>

<success_criteria>
- ZohoCRMService refactored to use OAuthTokenService
- ZohoCalendarService refactored to use OAuthTokenService
- Both services compile without TypeScript errors
- Token refresh goes through OAuthTokenService (DB persistence)
- forClient() updated to pass clientId for token lookup
</success_criteria>

<output>
After completion, create `.planning/phases/05-crm-synchronization/05-02-SUMMARY.md`
</output>
