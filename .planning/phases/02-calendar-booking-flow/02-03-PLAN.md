---
phase: 02-calendar-booking-flow
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - backend/src/services/divine/function-dispatcher.service.ts
autonomous: false

must_haves:
  truths:
    - "SMS confirmation sends after booking"
    - "Email confirmation sends after booking (if enabled)"
    - "Full booking flow works end-to-end via Retell webhook"
  artifacts:
    - path: "backend/src/services/divine/function-dispatcher.service.ts"
      provides: "Booking with SMS and email confirmation"
      exports: ["functionDispatcherService"]
    - path: "backend/src/services/divine/message-queue.service.ts"
      provides: "Message queuing for confirmations"
      exports: ["messageQueueService"]
  key_links:
    - from: "function-dispatcher.service.ts"
      to: "message-queue.service.ts"
      via: "enqueueSMS after booking"
      pattern: "messageQueueService.enqueueSMS"
    - from: "function-dispatcher.service.ts"
      to: "message-queue.service.ts"
      via: "enqueueEmail after booking"
      pattern: "messageQueueService.enqueueEmail"
---

<objective>
Add email confirmation after booking and verify full booking flow end-to-end.

Purpose: Complete the booking confirmation flow by adding email notification alongside SMS, then validate the entire flow works through Retell webhooks.

Output: Complete booking flow with SMS and email confirmations, verified end-to-end.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-booking-flow/02-RESEARCH.md
@.planning/phases/02-calendar-booking-flow/02-02-SUMMARY.md

@backend/src/services/divine/function-dispatcher.service.ts
@backend/src/services/divine/message-queue.service.ts
@backend/config/clients/smart-tax-nation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Email Confirmation After Booking</name>
  <files>backend/src/services/divine/function-dispatcher.service.ts</files>
  <action>
    Add email confirmation to bookAppointment function (after the SMS confirmation block, around line 318).

    Currently only SMS is sent. Add email confirmation when email is enabled and customer provides email:

    ```typescript
    // Queue confirmation SMS (existing code around line 302-317)
    if (context.clientConfig.sms_enabled) {
      const confirmationMessage = `Your appointment at ${context.clientConfig.business_name} is confirmed for ${format(appointmentTime, "EEEE, MMMM do 'at' h:mm a")}. Location: ${context.clientConfig.address}. Reply CANCEL to cancel.`;

      await messageQueueService.enqueueSMS(
        context.clientConfig.client_id,
        args.customer_phone,
        confirmationMessage,
        {
          customerId: customer.id,
          metadata: {
            type: 'appointment_confirmation',
            eventId,
            appointmentTime: args.datetime,
          },
        }
      );
    }

    // ADD THIS: Queue confirmation email
    if (context.clientConfig.email_enabled && args.customer_email) {
      const emailSubject = `Appointment Confirmed - ${context.clientConfig.business_name}`;
      const emailBody = `
Hello ${args.customer_name || 'there'},

Your appointment has been confirmed!

Date: ${format(appointmentTime, 'EEEE, MMMM do, yyyy')}
Time: ${format(appointmentTime, 'h:mm a')}
Location: ${context.clientConfig.address || 'To be confirmed'}

${args.appointment_type ? `Appointment Type: ${args.appointment_type}` : ''}

If you need to reschedule or cancel, please call us or reply to this email.

Thank you for choosing ${context.clientConfig.business_name}!

Best regards,
${context.clientConfig.business_name} Team
      `.trim();

      await messageQueueService.enqueueEmail(
        context.clientConfig.client_id,
        args.customer_email,
        emailSubject,
        emailBody,
        {
          customerId: customer.id,
          metadata: {
            type: 'appointment_confirmation',
            eventId,
            appointmentTime: args.datetime,
          },
        }
      );
    }
    ```

    This adds email confirmation when:
    1. Client has email_enabled: true in config (Smart Tax Nation does)
    2. Customer provided an email address during booking
  </action>
  <verify>TypeScript compiles without errors: `cd backend && npm run build`</verify>
  <done>Email confirmation queued after booking when email is provided and enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Test Confirmation Flow via Webhook</name>
  <files>backend/scripts/test-function-dispatch.ts</files>
  <action>
    Test the full booking flow by simulating a Retell function call webhook.

    1. Start the backend server:
    ```bash
    cd backend && npm run dev
    ```

    2. Send a test webhook request to book an appointment:
    ```bash
    curl -X POST "http://localhost:3000/api/webhooks/retell/smart-tax-nation/function" \
      -H "Content-Type: application/json" \
      -d '{
        "call": {
          "call_id": "test-call-e2e-001",
          "agent_id": "agent_2902ef6cd0a87f863052e3efff",
          "from_number": "+15555551234",
          "to_number": "+18005551234",
          "direction": "inbound"
        },
        "function_call": {
          "name": "book_appointment",
          "arguments": {
            "customer_name": "Test User",
            "customer_phone": "+15555551234",
            "customer_email": "test@example.com",
            "datetime": "2026-01-21T14:00:00.000Z",
            "appointment_type": "Tax Consultation",
            "notes": "E2E test booking - please delete"
          }
        }
      }'
    ```

    3. Verify response contains:
       - `event_id` (from Zoho Calendar)
       - `confirmed_datetime`
       - `confirmation_sent: true`

    4. Check database for queued messages:
    ```bash
    # Check message queue for SMS and email
    psql $DATABASE_URL -c "SELECT * FROM message_queue WHERE client_id = 'smart-tax-nation' ORDER BY created_at DESC LIMIT 5;"
    ```

    Note: This creates a real calendar event and queues real messages. Delete test data after verification.
  </action>
  <verify>Webhook returns 200 with booking confirmation. Message queue contains SMS and email entries.</verify>
  <done>Full booking flow tested via webhook - calendar event created, confirmations queued.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify End-to-End Booking Flow</name>
  <what-built>Complete calendar booking flow with SMS and email confirmations.</what-built>
  <how-to-verify>
    Verify the complete booking flow works:

    1. **Calendar Event Created:**
       - Check Zoho Calendar for the test appointment
       - Verify date/time is correct (Jan 21, 2026 at 2:00 PM EST)
       - Delete the test event after verification

    2. **SMS Confirmation Queued:**
       - Check message_queue table for SMS entry
       - Recipient should be +15555551234
       - Message should contain appointment details

    3. **Email Confirmation Queued:**
       - Check message_queue table for email entry
       - Recipient should be test@example.com
       - Subject should contain "Appointment Confirmed"

    4. **Optional - Test with Real Phone:**
       - If you want to test actual SMS delivery, use a real phone number
       - Requires SMS provider (txt180) to be configured and funded

    Clean up:
    - Delete test event from Zoho Calendar
    - Clear test entries from message_queue table
  </how-to-verify>
  <resume-signal>Type "booking flow verified" to confirm, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Email confirmation code added to bookAppointment
- [ ] TypeScript compiles without errors
- [ ] Webhook test creates calendar event
- [ ] SMS confirmation queued in database
- [ ] Email confirmation queued in database (when email provided)
- [ ] Calendar event visible in Zoho Calendar
</verification>

<success_criteria>
1. Booking via webhook creates Zoho Calendar event
2. SMS confirmation is queued immediately after booking
3. Email confirmation is queued when customer provides email
4. Response includes event_id and confirmation status
5. Full flow works without errors in logs
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-booking-flow/02-03-SUMMARY.md`
</output>
