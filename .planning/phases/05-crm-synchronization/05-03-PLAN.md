---
phase: 05-crm-synchronization
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/services/divine/post-call-processor.ts
autonomous: true

must_haves:
  truths:
    - "Appointment time syncs to CRM lead notes when booked"
    - "Customer name and email sync to CRM lead if available"
    - "CRM sync failures alert via Slack without blocking call processing"
  artifacts:
    - path: "backend/src/services/divine/post-call-processor.ts"
      provides: "Enhanced CRM sync with appointment data and error alerting"
      contains: "alertingService"
  key_links:
    - from: "backend/src/services/divine/post-call-processor.ts"
      to: "backend/src/services/divine/alerting.service.ts"
      via: "import and error call"
      pattern: "alertingService\\.error"
    - from: "backend/src/services/divine/post-call-processor.ts"
      to: "backend/src/services/divine/zoho-crm.service.ts"
      via: "enhanced sync method"
      pattern: "zohoCRMService\\.(getOrCreateByPhone|addNote|updateLead)"
---

<objective>
Enhance post-call CRM synchronization with appointment data and error alerting.

Purpose: Currently, post-call processor syncs basic lead info and call summary. Per 05-RESEARCH.md, appointment time/type and customer details are NOT being synced. Additionally, CRM failures log silently without alerting.

Output:
- Enhanced CRM sync with appointment data in lead notes
- Customer name/email synced to lead record
- CRM sync failures trigger Slack alerts via alertingService
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-crm-synchronization/05-RESEARCH.md

# Service to update
@backend/src/services/divine/post-call-processor.ts
@backend/src/services/divine/zoho-crm.service.ts
@backend/src/services/divine/alerting.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alertingService import and enhance CRM error handling</name>
  <files>backend/src/services/divine/post-call-processor.ts</files>
  <action>
Update `backend/src/services/divine/post-call-processor.ts`:

1. Add alertingService import (near top with other imports):
```typescript
import { alertingService } from './alerting.service';
```

2. Replace the current CRM sync block (lines ~70-94) with enhanced version:

```typescript
// 7. Sync to CRM if configured
if (zohoCRMService.isConfigured()) {
  try {
    await this.syncToCRM(data, customer, intent, entities, prismAnalysis);
  } catch (error) {
    logger.error({ error, callId: data.callId }, 'CRM sync failed');

    // Alert via multi-channel alerting service
    await alertingService.error(
      'CRM Sync Failed',
      `Lead sync failed for call ${data.callId}. Customer: ${data.phone}`,
      {
        clientId: data.clientId,
        callId: data.callId,
        error: error instanceof Error ? error : new Error(String(error)),
      }
    );

    // Continue processing - graceful degradation per REQ-006
  }
}
```

3. Add new private method for CRM sync (after determineSentiment method):

```typescript
/**
 * Sync customer and call data to CRM with enhanced field mapping.
 * Per 05-RESEARCH.md: Include appointment data, customer details, PRISM scores.
 */
private async syncToCRM(
  data: PostCallData,
  customer: { id: string; name?: string | null; email?: string | null; crmId?: string | null },
  intent: string,
  entities: Record<string, string>,
  prismAnalysis: PRISMAnalysis
): Promise<void> {
  // Build lead data with customer details
  const leadData: {
    leadSource: string;
    description: string;
    firstName?: string;
    lastName?: string;
    email?: string;
    customFields?: Record<string, unknown>;
  } = {
    leadSource: 'Voice AI',
    description: `Last call: ${data.summary || 'No summary'}`,
  };

  // Add customer name if available
  if (customer.name) {
    const nameParts = customer.name.split(' ');
    leadData.firstName = nameParts[0];
    if (nameParts.length > 1) {
      leadData.lastName = nameParts.slice(1).join(' ');
    }
  }

  // Add email if available
  if (customer.email) {
    leadData.email = customer.email;
  }

  // Add custom fields for CRM
  leadData.customFields = {
    Last_Intent: intent,
    Total_Calls: (customer as any).totalCalls || 1,
  };

  // Add dominant PRISM need if detected
  if (prismAnalysis.dominantNeeds && prismAnalysis.dominantNeeds.length > 0) {
    leadData.customFields.PRISM_Dominant = prismAnalysis.dominantNeeds[0];
  }

  // Get or create lead
  const lead = await zohoCRMService.getOrCreateByPhone(data.phone, leadData);

  // Build comprehensive note content
  const noteContent: string[] = [
    `Call Summary:`,
    data.summary || 'No summary available',
    '',
    `Intent: ${intent}`,
    `Duration: ${Math.round((data.durationMs || 0) / 1000)}s`,
  ];

  // Add appointment info if booked
  if (entities['appointment_time']) {
    noteContent.push('');
    noteContent.push('--- Appointment Details ---');
    noteContent.push(`Scheduled: ${entities['appointment_time']}`);
    if (entities['appointment_type']) {
      noteContent.push(`Type: ${entities['appointment_type']}`);
    }
  }

  // Add PRISM behavioral insights
  if (prismAnalysis.dominantNeeds && prismAnalysis.dominantNeeds.length > 0) {
    noteContent.push('');
    noteContent.push('--- Behavioral Insights ---');
    noteContent.push(`Dominant needs: ${prismAnalysis.dominantNeeds.join(', ')}`);
  }

  await zohoCRMService.addNote(
    lead.id,
    noteContent.join('\n'),
    `Voice AI Call - ${new Date().toLocaleDateString()}`
  );

  // Update customer with CRM ID if not already linked
  if (!customer.crmId) {
    await customerService.update(customer.id, {
      crmId: lead.id,
      crmProvider: 'zoho',
    });
  }

  logger.info({ callId: data.callId, leadId: lead.id }, 'CRM sync completed');
}
```

4. Update the process method signature for prismAnalysis (if needed):
The prismAnalysis variable is already available in scope from step 4 of process().

WHY these changes:
- Extracts CRM logic into dedicated method for maintainability
- Includes appointment_time and appointment_type in CRM note
- Adds customer name/email to lead record
- Uses alertingService for error notifications (per Phase 3 patterns)
- Graceful degradation: CRM failures don't block post-call processing
  </action>
  <verify>Run `npm run build` in backend/ - verify no TypeScript errors. Check that alertingService import is present and used.</verify>
  <done>Post-call processor has enhanced CRM sync with appointment data, customer details, and Slack alerting on failures.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes in backend/
2. alertingService imported in post-call-processor.ts
3. syncToCRM method includes appointment_time and appointment_type
4. CRM errors trigger alertingService.error() call
5. Customer name split into firstName/lastName for CRM
</verification>

<success_criteria>
- Appointment time and type included in CRM lead notes
- Customer name/email synced to CRM lead record
- CRM sync failures send Slack alert via alertingService
- Post-call processing continues even if CRM sync fails
- PRISM behavioral insights included in lead notes
</success_criteria>

<output>
After completion, create `.planning/phases/05-crm-synchronization/05-03-SUMMARY.md`
</output>
