---
phase: 06.1-client-onboarding-oauth-hardening
plan: 03
type: execute
wave: 2
depends_on: ["06.1-01", "06.1-02"]
files_modified:
  - backend/src/services/divine/onboarding.service.ts
  - backend/src/routes/divine.ts
autonomous: true

must_haves:
  truths:
    - "Admin can query setup checklist for any client and see which steps are complete"
    - "Checklist covers: config created, CRM authorized, Calendar authorized, SMS configured, email configured, business hours set"
    - "Checklist returns ready=true only when all required steps pass"
  artifacts:
    - path: "backend/src/services/divine/onboarding.service.ts"
      provides: "Setup checklist validation logic"
      exports: ["onboardingService"]
      min_lines: 60
  key_links:
    - from: "backend/src/services/divine/onboarding.service.ts"
      to: "backend/src/services/divine/client-config.service.ts"
      via: "checks config existence and field completeness"
      pattern: "clientConfigService"
    - from: "backend/src/services/divine/onboarding.service.ts"
      to: "backend/src/services/divine/oauth-token.service.ts"
      via: "checks token existence per provider"
      pattern: "oauthTokenService"
    - from: "backend/src/routes/divine.ts"
      to: "backend/src/services/divine/onboarding.service.ts"
      via: "GET /divine/clients/:clientId/setup endpoint"
      pattern: "onboardingService"
---

<objective>
Create the onboarding/setup checklist service and API endpoint for guided client provisioning.

Purpose: Admins need a single endpoint to see what's configured and what's missing for any client, enabling systematic onboarding.
Output: OnboardingService with setup validation + GET endpoint returning checklist status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-RESEARCH.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-01-SUMMARY.md
@.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-02-SUMMARY.md
@backend/src/services/divine/client-config.service.ts
@backend/src/services/divine/oauth-token.service.ts
@backend/src/routes/divine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OnboardingService with setup checklist</name>
  <files>backend/src/services/divine/onboarding.service.ts</files>
  <action>
    Create `backend/src/services/divine/onboarding.service.ts`:

    **SetupChecklist interface:**
    ```typescript
    interface SetupChecklist {
      clientId: string;
      steps: {
        config_created: boolean;
        zoho_crm_authorized: boolean;
        zoho_calendar_authorized: boolean;
        sms_configured: boolean;
        email_configured: boolean;
        business_hours_set: boolean;
        retell_configured: boolean;
      };
      tokenHealth: {
        zoho_crm: string | null;   // 'healthy'|'expiring'|'refresh_failed'|'invalid'|null (no token)
        zoho_calendar: string | null;
      };
      ready: boolean;
      issues: string[];
    }
    ```

    **getSetupChecklist(clientId: string): Promise<SetupChecklist>**
    1. Load config via clientConfigService.getConfig(clientId)
    2. Check each step:
       - config_created: config !== null
       - zoho_crm_authorized: oauthTokenService.hasToken(clientId, 'zoho_crm')
       - zoho_calendar_authorized: oauthTokenService.hasToken(clientId, 'zoho_calendar')
       - sms_configured: config?.sms_enabled && (config?.sms_provider is set)
       - email_configured: config?.email_enabled && (config?.email_provider is set)
       - business_hours_set: config?.business_hours has at least one non-closed day
       - retell_configured: config?.retell_agent_id is truthy
    3. Get token health: oauthTokenService.getTokenRecord for each provider, read tokenStatus
    4. Build issues array: for each false step, add descriptive string like "Zoho CRM not authorized - run OAuth flow"
    5. ready = config_created && zoho_crm_authorized && zoho_calendar_authorized && retell_configured (minimum required)

    Export singleton: `export const onboardingService = new OnboardingService();`
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>OnboardingService returns comprehensive setup checklist for any client</done>
</task>

<task type="auto">
  <name>Task 2: Add setup checklist API endpoint</name>
  <files>backend/src/routes/divine.ts</files>
  <action>
    Add to divine.ts routes (in the CLIENT CONFIGURATION section):

    **GET /divine/clients/:clientId/setup** (authenticateToken + requireAdmin):
    1. Import onboardingService
    2. Call onboardingService.getSetupChecklist(req.params.clientId)
    3. Return createTheatricalResponse({ checklist })

    Also add onboardingService to the divine services index if there is one (check `backend/src/services/divine/index.ts`).
  </action>
  <verify>
    TypeScript compiles. Route exists and returns checklist data structure.
    `curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/divine/clients/smart-tax-nation/setup` returns setup checklist JSON.
  </verify>
  <done>GET /divine/clients/:clientId/setup returns setup checklist with steps, tokenHealth, ready, and issues</done>
</task>

</tasks>

<verification>
- OnboardingService compiles and checks all setup steps
- API endpoint mounted and returns checklist JSON
- Checklist correctly reflects config existence, token authorization status, and provider configuration
- ready flag only true when minimum requirements met
</verification>

<success_criteria>
Admin can call GET /divine/clients/:clientId/setup and see exactly which onboarding steps are complete, which are missing, and whether the client is ready for production.
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-client-onboarding-oauth-hardening/06.1-03-SUMMARY.md`
</output>
