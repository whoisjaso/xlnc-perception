---
phase: 05-crm-synchronization
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - backend/scripts/test-crm-sync.ts
autonomous: true

must_haves:
  truths:
    - "CRM service can authenticate via database-backed tokens"
    - "Lead creation works with phone number lookup"
    - "Note attachment works with appointment data"
    - "Token refresh persists to database"
  artifacts:
    - path: "backend/scripts/test-crm-sync.ts"
      provides: "End-to-end CRM integration test script"
      contains: "zohoCRMService"
  key_links:
    - from: "backend/scripts/test-crm-sync.ts"
      to: "backend/src/services/divine/zoho-crm.service.ts"
      via: "import and method calls"
      pattern: "zohoCRMService\\.(isConfigured|getOrCreateByPhone|addNote)"
---

<objective>
Create end-to-end CRM integration test script.

Purpose: Verify the complete CRM synchronization flow works with database-backed OAuth tokens. This validates: token refresh, lead creation/lookup, note attachment, and appointment data sync.

Output:
- `test-crm-sync.ts` script that verifies CRM integration end-to-end
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-crm-synchronization/05-01-SUMMARY.md
@.planning/phases/05-crm-synchronization/05-02-SUMMARY.md
@.planning/phases/05-crm-synchronization/05-03-SUMMARY.md

# Reference for test script patterns
@backend/scripts/test-function-dispatch.ts
@backend/src/services/divine/zoho-crm.service.ts
@backend/src/services/divine/oauth-token.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CRM integration test script</name>
  <files>backend/scripts/test-crm-sync.ts</files>
  <action>
Create `backend/scripts/test-crm-sync.ts`:

```typescript
/**
 * Test script for CRM synchronization
 * Verifies: OAuth tokens, lead creation, note attachment, appointment data
 *
 * Usage: npx tsx scripts/test-crm-sync.ts
 */
import { zohoCRMService, ZohoCRMService } from '../src/services/divine/zoho-crm.service';
import { oauthTokenService } from '../src/services/divine/oauth-token.service';
import { db } from '../src/db';
import { oauthTokens } from '../src/db/schema/oauthTokens';
import { eq, and } from 'drizzle-orm';
import env from '../src/config/env';

const TEST_PHONE = '+15555550123'; // Use a test phone number

async function main() {
  console.log('=== CRM Synchronization Test ===\n');

  // 1. Check CRM service configuration
  console.log('1. Checking CRM service configuration...');
  const isConfigured = zohoCRMService.isConfigured();
  console.log(`   Configured: ${isConfigured}`);

  if (!isConfigured) {
    console.log('\n   ERROR: CRM service not configured.');
    console.log('   Required env vars: ZOHO_CLIENT_ID, ZOHO_CLIENT_SECRET, ZOHO_REFRESH_TOKEN');
    process.exit(1);
  }

  // 2. Test OAuth token retrieval (uses OAuthTokenService)
  console.log('\n2. Testing OAuth token retrieval...');
  try {
    const accessToken = await zohoCRMService.getAccessToken();
    console.log(`   Access token obtained: ${accessToken.slice(0, 20)}...`);
    console.log('   SUCCESS: OAuth token retrieval works');
  } catch (error) {
    console.log(`   ERROR: ${error instanceof Error ? error.message : error}`);
    process.exit(1);
  }

  // 3. Check database token storage
  console.log('\n3. Checking database token storage...');
  try {
    const stored = await db.select()
      .from(oauthTokens)
      .where(and(
        eq(oauthTokens.clientId, 'default'),
        eq(oauthTokens.provider, 'zoho_crm')
      ))
      .limit(1);

    if (stored.length > 0) {
      console.log('   Token found in database:');
      console.log(`   - Client ID: ${stored[0].clientId}`);
      console.log(`   - Provider: ${stored[0].provider}`);
      console.log(`   - Token Expiry: ${stored[0].tokenExpiry}`);
      console.log(`   - Updated At: ${stored[0].updatedAt}`);
      console.log('   SUCCESS: Tokens persisted to database');
    } else {
      console.log('   No token in database yet (will be created on first use)');
    }
  } catch (error) {
    console.log(`   WARNING: Could not check database: ${error instanceof Error ? error.message : error}`);
  }

  // 4. Test lead lookup by phone
  console.log('\n4. Testing lead lookup by phone...');
  try {
    const existingLead = await zohoCRMService.findByPhone(TEST_PHONE);
    if (existingLead) {
      console.log(`   Found existing lead: ${existingLead.id}`);
      console.log(`   - Name: ${existingLead.firstName} ${existingLead.lastName}`);
      console.log(`   - Email: ${existingLead.email}`);
      console.log(`   - Phone: ${existingLead.phone}`);
    } else {
      console.log('   No existing lead found (expected for test phone)');
    }
    console.log('   SUCCESS: Lead lookup works');
  } catch (error) {
    console.log(`   ERROR: ${error instanceof Error ? error.message : error}`);
    // Continue testing - lookup errors shouldn't block other tests
  }

  // 5. Test lead creation (getOrCreateByPhone)
  console.log('\n5. Testing lead creation (getOrCreateByPhone)...');
  try {
    const lead = await zohoCRMService.getOrCreateByPhone(TEST_PHONE, {
      firstName: 'Test',
      lastName: 'User',
      leadSource: 'Voice AI - Test Script',
      description: 'Test lead created by CRM sync verification script',
      customFields: {
        Last_Intent: 'test',
        Total_Calls: 1,
      },
    });
    console.log(`   Lead ID: ${lead.id}`);
    console.log(`   - Name: ${lead.firstName} ${lead.lastName}`);
    console.log(`   - Source: ${lead.leadSource}`);
    console.log('   SUCCESS: Lead creation works');

    // 6. Test note attachment with appointment data
    console.log('\n6. Testing note attachment with appointment data...');
    const noteContent = [
      'Call Summary:',
      'Test call for CRM sync verification',
      '',
      'Intent: test',
      'Duration: 60s',
      '',
      '--- Appointment Details ---',
      'Scheduled: January 28, 2026 at 2:00 PM',
      'Type: Initial Consultation',
      '',
      '--- Behavioral Insights ---',
      'Dominant needs: power, safety',
    ].join('\n');

    await zohoCRMService.addNote(
      lead.id,
      noteContent,
      `Voice AI Test - ${new Date().toLocaleDateString()}`
    );
    console.log('   Note attached successfully');
    console.log('   SUCCESS: Note attachment works');

  } catch (error) {
    console.log(`   ERROR: ${error instanceof Error ? error.message : error}`);
    process.exit(1);
  }

  // 7. Verify token was refreshed and stored
  console.log('\n7. Verifying token persistence after operations...');
  try {
    const stored = await db.select()
      .from(oauthTokens)
      .where(and(
        eq(oauthTokens.clientId, 'default'),
        eq(oauthTokens.provider, 'zoho_crm')
      ))
      .limit(1);

    if (stored.length > 0 && stored[0].accessToken) {
      console.log('   Token in database:');
      console.log(`   - Has access token: ${Boolean(stored[0].accessToken)}`);
      console.log(`   - Has refresh token: ${Boolean(stored[0].refreshToken)}`);
      console.log(`   - Expiry: ${stored[0].tokenExpiry}`);
      const expiresIn = stored[0].tokenExpiry
        ? Math.round((stored[0].tokenExpiry.getTime() - Date.now()) / 1000 / 60)
        : 0;
      console.log(`   - Expires in: ${expiresIn} minutes`);
      console.log('   SUCCESS: Tokens persisted correctly');
    } else {
      console.log('   WARNING: Token not found in database');
    }
  } catch (error) {
    console.log(`   WARNING: Could not verify: ${error instanceof Error ? error.message : error}`);
  }

  console.log('\n=== All CRM Tests Passed ===');
  console.log('\nCRM synchronization is ready for production use.');

  process.exit(0);
}

main().catch((error) => {
  console.error('Test failed:', error);
  process.exit(1);
});
```

WHY this test script:
- Verifies OAuth token flow through OAuthTokenService
- Confirms database token persistence (blocker fixed)
- Tests lead creation and lookup (REQ-006)
- Tests note attachment with appointment data format
- Follows existing test script patterns (test-function-dispatch.ts)
  </action>
  <verify>Run `npx tsx scripts/test-crm-sync.ts` from backend/ directory. Script should complete with "All CRM Tests Passed".</verify>
  <done>test-crm-sync.ts exists and validates CRM integration end-to-end</done>
</task>

<task type="auto">
  <name>Task 2: Run and verify CRM integration test</name>
  <files>N/A - verification only</files>
  <action>
Execute the test script and verify all checks pass:

```bash
cd backend && npx tsx scripts/test-crm-sync.ts
```

Expected output:
1. CRM service configured: yes
2. OAuth token obtained
3. Database token storage verified
4. Lead lookup works
5. Lead creation works (getOrCreateByPhone)
6. Note attachment with appointment data works
7. Token persistence verified

If any step fails:
- Check env vars: ZOHO_CLIENT_ID, ZOHO_CLIENT_SECRET, ZOHO_REFRESH_TOKEN
- Verify database connection
- Check Zoho API access (tokens may need regeneration)

Document any issues or manual steps needed.
  </action>
  <verify>Test script output shows "All CRM Tests Passed". Database contains oauth_tokens record with valid access_token and token_expiry.</verify>
  <done>CRM integration verified working. Test script passes all checks.</done>
</task>

</tasks>

<verification>
1. test-crm-sync.ts exists in backend/scripts/
2. Script runs without errors: `npx tsx scripts/test-crm-sync.ts`
3. OAuth token obtained and stored in database
4. Lead creation/lookup works
5. Note attachment includes appointment data format
6. All test steps pass
</verification>

<success_criteria>
- Test script exists and is executable
- OAuth tokens persist to oauth_tokens table
- Lead operations (find, create, update) work
- Note attachment includes appointment details
- Script output confirms "All CRM Tests Passed"
</success_criteria>

<output>
After completion, create `.planning/phases/05-crm-synchronization/05-04-SUMMARY.md`
</output>
