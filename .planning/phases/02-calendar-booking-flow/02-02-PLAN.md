---
phase: 02-calendar-booking-flow
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/src/services/divine/zoho-calendar.service.ts
autonomous: true

must_haves:
  truths:
    - "check_calendar_availability returns accurate available slots"
    - "book_appointment creates calendar event in Zoho"
    - "Timezone is correctly handled for Smart Tax Nation"
    - "Business hours are respected when computing slots"
  artifacts:
    - path: "backend/src/services/divine/zoho-calendar.service.ts"
      provides: "Calendar operations with dynamic timezone"
      exports: ["ZohoCalendarService"]
    - path: "backend/src/services/divine/function-dispatcher.service.ts"
      provides: "Function call routing"
      exports: ["functionDispatcherService"]
  key_links:
    - from: "function-dispatcher.service.ts"
      to: "zoho-calendar.service.ts"
      via: "ZohoCalendarService.forClient()"
      pattern: "getCalendarServiceForClient"
    - from: "zoho-calendar.service.ts"
      to: "Zoho Calendar API"
      via: "createEvent POST"
      pattern: "calendars.*events"
---

<objective>
Test calendar functions end-to-end with real Zoho API and fix timezone handling.

Purpose: Validate that check_calendar_availability and book_appointment work correctly with Smart Tax Nation's Zoho Calendar before enabling in production.

Output: Verified calendar functions with proper timezone handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-calendar-booking-flow/02-RESEARCH.md
@.planning/phases/02-calendar-booking-flow/02-01-SUMMARY.md

@backend/src/services/divine/zoho-calendar.service.ts
@backend/src/services/divine/function-dispatcher.service.ts
@backend/config/clients/smart-tax-nation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Timezone Handling in Calendar Service</name>
  <files>backend/src/services/divine/zoho-calendar.service.ts</files>
  <action>
    Fix the hardcoded timezone in createEvent method (line ~153).

    Current code:
    ```typescript
    timezone: 'America/New_York',
    ```

    Change to accept timezone as parameter and pass it through:

    1. Update the createEvent method signature to accept an optional timezone parameter:
       ```typescript
       async createEvent(
         event: Omit<CalendarEvent, 'id'>,
         timezone: string = 'America/New_York'
       ): Promise<CalendarEvent>
       ```

    2. Use the passed timezone in the event data:
       ```typescript
       dateandtime: {
         start: event.startTime.toISOString(),
         end: event.endTime.toISOString(),
         timezone: timezone,
       },
       ```

    This allows callers to pass clientConfig.timezone for proper timezone handling.
  </action>
  <verify>TypeScript compiles without errors: `cd backend && npm run build`</verify>
  <done>createEvent accepts timezone parameter, defaulting to America/New_York for backward compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Update Function Dispatcher to Pass Timezone</name>
  <files>backend/src/services/divine/function-dispatcher.service.ts</files>
  <action>
    Update bookAppointment in function-dispatcher.service.ts to pass client timezone.

    Find the createEvent call (around line 277-284) and update it to pass timezone:

    ```typescript
    const event = await calendarService.createEvent(
      {
        title: `${args.customer_name} - ${args.appointment_type || 'Appointment'}`,
        startTime: appointmentTime,
        endTime: new Date(appointmentTime.getTime() + 30 * 60 * 1000),
        description: args.notes || `Booked via voice AI. Phone: ${args.customer_phone}`,
        attendees: args.customer_email ? [args.customer_email] : [],
        location: context.clientConfig.address,
      },
      context.clientConfig.timezone || 'America/New_York'
    );
    ```

    This ensures events are created with the client's configured timezone (Smart Tax Nation uses America/New_York).
  </action>
  <verify>TypeScript compiles without errors: `cd backend && npm run build`</verify>
  <done>Timezone is passed from client config to calendar event creation.</done>
</task>

<task type="auto">
  <name>Task 3: End-to-End Calendar Function Test</name>
  <files>backend/scripts/test-function-dispatch.ts</files>
  <action>
    Create a comprehensive test that validates the full calendar flow.

    1. Update test-function-dispatch.ts to actually create a test event (uncomment and modify):

    ```typescript
    async function testBookAppointment(slots: any[] | null) {
      console.log('\n=== Testing Appointment Booking (LIVE) ===\n');

      if (!slots || slots.length === 0) {
        console.log('No slots available to test booking');
        return;
      }

      const calendarService = new ZohoCalendarService();
      const testSlot = slots[0];

      console.log(`Creating test event at: ${testSlot.formatted}`);

      try {
        const event = await calendarService.createEvent(
          {
            title: 'TEST - Auto Delete - Tax Consultation',
            startTime: testSlot.start,
            endTime: testSlot.end,
            description: 'AUTOMATED TEST - Safe to delete. Created by test-function-dispatch.ts',
            attendees: [],
          },
          'America/New_York'
        );

        console.log('✓ Event created successfully!');
        console.log(`  Event ID: ${event.id}`);
        console.log(`  Title: ${event.title}`);
        console.log(`  Time: ${testSlot.formatted}`);
        console.log('\n⚠️  Remember to delete this test event from Zoho Calendar');

        return event;
      } catch (error) {
        console.error('❌ Failed to create event:', error);
        return null;
      }
    }
    ```

    2. Run the test:
    ```bash
    cd backend && npx tsx scripts/test-function-dispatch.ts
    ```

    3. After test completes, verify:
       - Event appears in Zoho Calendar
       - Time is correct (not off by timezone)
       - Event can be manually deleted

    Note: The test creates a real event. User should delete it from Zoho Calendar after verification.
  </action>
  <verify>Test script creates event in Zoho Calendar and outputs event ID. Event visible in Zoho Calendar UI.</verify>
  <done>Calendar event creation verified end-to-end with correct timezone.</done>
</task>

</tasks>

<verification>
- [ ] Timezone fix compiles successfully
- [ ] Function dispatcher passes timezone from client config
- [ ] Test event created in Zoho Calendar
- [ ] Event time is correct (not shifted by timezone)
- [ ] Test event can be seen in Zoho Calendar UI
</verification>

<success_criteria>
1. TypeScript builds without errors after timezone changes
2. Test script successfully creates calendar event
3. Event appears in Zoho Calendar at correct time
4. Timezone is correctly set to America/New_York for Smart Tax Nation
</success_criteria>

<output>
After completion, create `.planning/phases/02-calendar-booking-flow/02-02-SUMMARY.md`
</output>
