---
phase: 1
plan: 1
title: Smart Tax Nation Client Configuration
wave: 1
depends_on: []
autonomous: true
gap_closure: false
created: 2026-01-18
---

# Plan 01-01: Smart Tax Nation Client Configuration

## Objective

Configure the Divine Agentic Intelligence System for Smart Tax Nation as the first production client. This includes creating the client configuration file, documenting environment variables, and fixing the webhook endpoint to properly load client configs.

## Context

**Current State Analysis:**

| Component | Status | Issue |
|-----------|--------|-------|
| Client Config Service | Working | Loads from `config/clients/*.json` |
| Zoho Calendar Service | Exists | Uses global env vars, has OAuth refresh |
| Zoho CRM Service | Exists | Uses global env vars, has OAuth refresh |
| Function Dispatcher | Working | Properly uses client config for features |
| Webhook Endpoint | **Broken** | Uses hardcoded default config, ignores client configs |

**Critical Issue Found:**
The webhook endpoint at `backend/src/routes/webhooks.ts:192-204` creates a hardcoded `ClientConfig` object instead of loading from `clientConfigService`. This means per-client configurations are never used.

## Requirements Addressed

- REQ-009: Smart Tax Nation Configuration

## Tasks

### Task 1: Create Smart Tax Nation Client Configuration
**File:** `backend/config/clients/smart-tax-nation.json`

Create the client configuration file with:
- Business details (name, phone, email, address)
- Business hours (typical tax office hours)
- Feature flags (calendar, CRM, SMS, email enabled)
- Retell agent ID placeholder
- Zoho calendar ID placeholder
- Tax industry-specific settings

**Acceptance:**
- [ ] File validates against ClientConfigSchema
- [ ] All required fields populated
- [ ] Business hours reflect tax office schedule

### Task 2: Update Environment Variable Documentation
**File:** `backend/.env.example`

Add missing environment variables for Smart Tax Nation:
- Zoho CRM credentials (client_id, client_secret, refresh_token)
- Zoho Calendar credentials (client_id, client_secret, refresh_token, calendar_id)
- Text180 SMS credentials (auth_key, account_id, short_code, keyword)
- Zoho SMTP credentials

**Acceptance:**
- [ ] All Zoho integration vars documented
- [ ] All SMS provider vars documented
- [ ] Clear comments explaining each variable

### Task 3: Fix Webhook Endpoint to Use Client Configs
**File:** `backend/src/routes/webhooks.ts`

The current implementation has a critical bug - it creates a hardcoded config instead of loading from the client config service. Need to:

1. Add new route `/api/webhooks/retell/:clientId` that loads config by clientId
2. Keep existing `/api/webhooks/retell` but load config by agent_id lookup
3. Use `clientConfigService.getConfig()` instead of hardcoded object
4. Fall back to default config if client not found (with warning log)

**Acceptance:**
- [ ] Webhook loads client config by clientId param
- [ ] Falls back gracefully if config not found
- [ ] Logs which client config was loaded

### Task 4: Create Environment Setup Guide
**File:** `backend/SETUP.md`

Create setup documentation for:
- How to obtain Zoho OAuth credentials
- How to configure Retell webhook URL
- Required vs optional environment variables
- Testing the configuration

**Acceptance:**
- [ ] Clear step-by-step instructions
- [ ] Links to Zoho API console
- [ ] Example curl commands for testing

## Verification

After completing all tasks:

1. **Schema Validation:**
   ```bash
   cd backend && npm run build
   ```
   Verify no TypeScript errors with new config.

2. **Config Loading:**
   ```bash
   curl http://localhost:3000/api/health
   ```
   Should show server running.

3. **Webhook Test:**
   ```bash
   curl http://localhost:3000/api/webhooks/retell/smart-tax-nation/test
   ```
   Should return client config acknowledgment.

## Key Files Reference

| Purpose | Path |
|---------|------|
| Client Config Service | `backend/src/services/divine/client-config.service.ts` |
| Env Validation | `backend/src/config/env.ts` |
| Webhook Routes | `backend/src/routes/webhooks.ts` |
| Type Definitions | `backend/src/types/retell.types.ts` |
| Example Config | `backend/config/clients/xlnc-demo.json` |

## Notes

- User confirmed they have all Smart Tax Nation credentials ready
- This plan focuses on configuration infrastructure, not testing with live Zoho API
- Phase 2 will verify actual Zoho Calendar integration works
