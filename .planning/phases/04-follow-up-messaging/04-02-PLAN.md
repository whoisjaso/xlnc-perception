---
phase: 04-follow-up-messaging
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/src/services/divine/reminder-scheduler.service.ts
  - backend/src/services/divine/message-queue.service.ts
  - backend/src/services/divine/index.ts
autonomous: true

must_haves:
  truths:
    - "Appointment reminders scheduled for 24h and 1h before appointment"
    - "Reminders include rescheduling option text"
    - "Scheduled messages stored in queue with future scheduledFor dates"
    - "Booking link and portal link included in reminder messages"
  artifacts:
    - path: "backend/src/services/divine/reminder-scheduler.service.ts"
      provides: "Appointment reminder scheduling service"
      exports: ["reminderSchedulerService", "scheduleAppointmentReminders"]
    - path: "backend/src/services/divine/message-queue.service.ts"
      provides: "Enhanced queue with messageType support"
      contains: "messageType"
  key_links:
    - from: "backend/src/services/divine/reminder-scheduler.service.ts"
      to: "backend/src/services/divine/message-queue.service.ts"
      via: "enqueueSMS/enqueueEmail with scheduledFor"
      pattern: "messageQueueService\\.enqueue"
---

<objective>
Implement scheduled appointment reminders (24h and 1h before) with booking and portal links.

Purpose: Per CONTEXT.md, customers should receive reminder messages 24 hours and 1 hour before their appointment, including rescheduling options. This improves show rates and customer experience.

Output: Reminder scheduler service that creates future-dated queue entries for both SMS and email reminders.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-follow-up-messaging/04-CONTEXT.md
@.planning/phases/04-follow-up-messaging/04-RESEARCH.md
@.planning/phases/04-follow-up-messaging/04-01-SUMMARY.md
@backend/src/services/divine/message-queue.service.ts
@backend/src/services/divine/followup-writer.service.ts
@backend/config/clients/smart-tax-nation.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Message Queue Service with messageType</name>
  <files>backend/src/services/divine/message-queue.service.ts</files>
  <action>
Update the enqueueSMS and enqueueEmail methods to accept messageType in options:

```typescript
options?: {
  customerId?: string;
  conversationId?: string;
  scheduledFor?: Date;
  metadata?: Record<string, unknown>;
  messageType?: 'confirmation' | 'reminder_24h' | 'reminder_1h' | 'nurture_day1' | 'nurture_day4' | 'post_call_followup' | 'manual';
}
```

Pass messageType to the enqueue call so it's stored in the database.

Also add a new method to retrieve scheduled messages for the next N hours:

```typescript
async getScheduledMessages(
  hoursAhead: number = 48,
  clientId?: string
): Promise<MessageQueueItem[]>
```

This method returns pending messages where scheduledFor is between now and now + hoursAhead, ordered by scheduledFor ascending.
  </action>
  <verify>TypeScript compiles without errors. The new messageType parameter is accepted.</verify>
  <done>enqueueSMS/enqueueEmail accept messageType option, getScheduledMessages method exists</done>
</task>

<task type="auto">
  <name>Task 2: Create Reminder Scheduler Service</name>
  <files>backend/src/services/divine/reminder-scheduler.service.ts</files>
  <action>
Create a new service for scheduling appointment reminders.

```typescript
import { messageQueueService } from './message-queue.service';
import { logger } from '../../utils/logger';
import { subHours } from 'date-fns';

interface AppointmentDetails {
  clientId: string;
  customerId: string;
  customerPhone: string;
  customerEmail?: string;
  customerName?: string;
  appointmentTime: Date;
  appointmentType?: string;
  businessName: string;
  bookingLink?: string;
  portalLink?: string;
}

export class ReminderSchedulerService {
  private readonly BOOKING_LINK = 'https://smarttaxnation.com/book'; // Default, can be overridden
  private readonly PORTAL_LINK = 'https://smarttaxnation.com/portal'; // Smart Tax Nation Portal for doc uploads

  /**
   * Schedule both 24h and 1h reminders for an appointment
   */
  async scheduleAppointmentReminders(appointment: AppointmentDetails): Promise<void> {
    const { appointmentTime, customerPhone, customerEmail, customerName, businessName, clientId, customerId, appointmentType } = appointment;

    const reminder24h = subHours(appointmentTime, 24);
    const reminder1h = subHours(appointmentTime, 1);

    const bookingLink = appointment.bookingLink || this.BOOKING_LINK;
    const portalLink = appointment.portalLink || this.PORTAL_LINK;

    // Format appointment time for display
    const timeStr = appointmentTime.toLocaleString('en-US', {
      weekday: 'long',
      month: 'long',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });

    // Only schedule if reminder time is in the future
    const now = new Date();

    // 24h SMS reminder
    if (reminder24h > now) {
      const sms24h = this.build24hSMSReminder(customerName, businessName, timeStr, bookingLink);
      await messageQueueService.enqueueSMS(clientId, customerPhone, sms24h, {
        customerId,
        scheduledFor: reminder24h,
        messageType: 'reminder_24h',
        metadata: { appointmentTime: appointmentTime.toISOString(), type: appointmentType }
      });
      logger.info({ clientId, customerId, scheduledFor: reminder24h }, '24h SMS reminder scheduled');
    }

    // 1h SMS reminder
    if (reminder1h > now) {
      const sms1h = this.build1hSMSReminder(customerName, businessName, timeStr);
      await messageQueueService.enqueueSMS(clientId, customerPhone, sms1h, {
        customerId,
        scheduledFor: reminder1h,
        messageType: 'reminder_1h',
        metadata: { appointmentTime: appointmentTime.toISOString(), type: appointmentType }
      });
      logger.info({ clientId, customerId, scheduledFor: reminder1h }, '1h SMS reminder scheduled');
    }

    // Email reminders if email available
    if (customerEmail) {
      if (reminder24h > now) {
        const { subject, body } = this.build24hEmailReminder(customerName, businessName, timeStr, bookingLink, portalLink);
        await messageQueueService.enqueueEmail(clientId, customerEmail, subject, body, {
          customerId,
          scheduledFor: reminder24h,
          messageType: 'reminder_24h',
          metadata: { appointmentTime: appointmentTime.toISOString(), type: appointmentType }
        });
      }

      if (reminder1h > now) {
        const { subject, body } = this.build1hEmailReminder(customerName, businessName, timeStr);
        await messageQueueService.enqueueEmail(clientId, customerEmail, subject, body, {
          customerId,
          scheduledFor: reminder1h,
          messageType: 'reminder_1h',
          metadata: { appointmentTime: appointmentTime.toISOString(), type: appointmentType }
        });
      }
    }
  }

  /**
   * Cancel scheduled reminders for an appointment (e.g., if cancelled/rescheduled)
   */
  async cancelAppointmentReminders(customerId: string, appointmentTime: Date): Promise<void> {
    // This would query and cancel pending reminders matching the appointment
    // Implementation: query by customerId + metadata.appointmentTime + status='pending'
    logger.info({ customerId, appointmentTime }, 'Cancelling appointment reminders');
    // TODO: Implement cancellation query
  }

  private build24hSMSReminder(name: string | undefined, business: string, timeStr: string, bookingLink: string): string {
    const greeting = name ? `Hi ${name}! ` : '';
    return `${greeting}Reminder: Your appointment with ${business} is tomorrow at ${timeStr.split(',').pop()?.trim()}. Need to reschedule? ${bookingLink}`;
  }

  private build1hSMSReminder(name: string | undefined, business: string, timeStr: string): string {
    const greeting = name ? `Hi ${name}! ` : '';
    return `${greeting}Your ${business} appointment is in 1 hour! We're looking forward to seeing you.`;
  }

  private build24hEmailReminder(
    name: string | undefined,
    business: string,
    timeStr: string,
    bookingLink: string,
    portalLink: string
  ): { subject: string; body: string } {
    const greeting = name ? `Hi ${name}` : 'Hi there';
    return {
      subject: `Reminder: Your ${business} appointment is tomorrow`,
      body: `
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .highlight { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #007bff; margin: 20px 0; }
    .btn { display: inline-block; padding: 12px 24px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; margin-right: 10px; margin-bottom: 10px; }
    .btn-secondary { background-color: #6c757d; }
    .footer { margin-top: 30px; color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <p>${greeting},</p>

    <p>This is a friendly reminder about your upcoming appointment with <strong>${business}</strong>.</p>

    <div class="highlight">
      <strong>Appointment Details:</strong><br>
      ${timeStr}
    </div>

    <p>If you need to make any changes, please let us know as soon as possible.</p>

    <p>
      <a href="${bookingLink}" class="btn">Reschedule Appointment</a>
      <a href="${portalLink}" class="btn btn-secondary">Upload Documents</a>
    </p>

    <p>We're looking forward to seeing you!</p>

    <div class="footer">
      <p>Best regards,<br>The ${business} Team</p>
    </div>
  </div>
</body>
</html>`
    };
  }

  private build1hEmailReminder(name: string | undefined, business: string, timeStr: string): { subject: string; body: string } {
    const greeting = name ? `Hi ${name}` : 'Hi there';
    return {
      subject: `Your ${business} appointment is in 1 hour`,
      body: `
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .highlight { background-color: #e8f5e9; padding: 15px; border-left: 4px solid #28a745; margin: 20px 0; }
    .footer { margin-top: 30px; color: #666; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <p>${greeting},</p>

    <div class="highlight">
      <strong>Your appointment is coming up in 1 hour!</strong><br>
      ${timeStr}
    </div>

    <p>We're excited to see you soon. If you have any last-minute questions, feel free to give us a call.</p>

    <div class="footer">
      <p>See you soon!<br>The ${business} Team</p>
    </div>
  </div>
</body>
</html>`
    };
  }
}

export const reminderSchedulerService = new ReminderSchedulerService();
```

Export the service.
  </action>
  <verify>TypeScript compiles. Service exports reminderSchedulerService.</verify>
  <done>reminder-scheduler.service.ts created with scheduleAppointmentReminders method</done>
</task>

<task type="auto">
  <name>Task 3: Export Reminder Scheduler from Divine Services Index</name>
  <files>backend/src/services/divine/index.ts</files>
  <action>
Add export for the new reminder scheduler service:

```typescript
export { reminderSchedulerService } from './reminder-scheduler.service';
```

This makes the service available for use in other parts of the application.
  </action>
  <verify>Import from divine services index works without error.</verify>
  <done>reminderSchedulerService exported from divine services index</done>
</task>

</tasks>

<verification>
1. Run `npm run build` - should compile without errors
2. Check message-queue.service.ts has messageType in enqueue methods
3. Check reminder-scheduler.service.ts has scheduleAppointmentReminders
4. Verify exports from index.ts include reminderSchedulerService
</verification>

<success_criteria>
- messageQueueService.enqueueSMS/enqueueEmail accept messageType option
- messageQueueService.getScheduledMessages returns future-scheduled messages
- reminderSchedulerService.scheduleAppointmentReminders creates 24h and 1h reminders
- Reminder SMS/email content includes booking link and portal link
- Reminders include rescheduling option text
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-follow-up-messaging/04-02-SUMMARY.md`
</output>
